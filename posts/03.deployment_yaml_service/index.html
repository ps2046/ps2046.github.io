<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="[kubernetes-실습] 간단한 application 배포, yaml템플릿, 서비스 expose 해보기" /><meta property="og:locale" content="en" /><meta name="description" content="kubernetes 인증 시험(CKA)에 대비하기 위해 실습을 해보도록 한다." /><meta property="og:description" content="kubernetes 인증 시험(CKA)에 대비하기 위해 실습을 해보도록 한다." /><link rel="canonical" href="https://ps2046.github.io/posts/03.deployment_yaml_service/" /><meta property="og:url" content="https://ps2046.github.io/posts/03.deployment_yaml_service/" /><meta property="og:site_name" content="ps’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-26T01:30:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[kubernetes-실습] 간단한 application 배포, yaml템플릿, 서비스 expose 해보기" /><meta name="twitter:site" content="@ps2046" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"kubernetes 인증 시험(CKA)에 대비하기 위해 실습을 해보도록 한다.","headline":"[kubernetes-실습] 간단한 application 배포, yaml템플릿, 서비스 expose 해보기","dateModified":"2021-08-26T00:00:00+09:00","url":"https://ps2046.github.io/posts/03.deployment_yaml_service/","datePublished":"2021-01-26T01:30:00+09:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ps2046.github.io/posts/03.deployment_yaml_service/"},"@context":"https://schema.org"}</script><title>[kubernetes-실습] 간단한 application 배포, yaml템플릿, 서비스 expose 해보기 | ps's Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ps's Blog"><meta name="application-name" content="ps's Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7635228999568716" crossorigin="anonymous"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/11029548?s=400&u=5ebc191faa53e931968ec2ed98bd7c7b68136c71&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ps's Blog</a></div><div class="site-subtitle font-italic">System Engineer & Developer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ps2046" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/ps2046" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ps2046.jang','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[kubernetes-실습] 간단한 application 배포, yaml템플릿, 서비스 expose 해보기</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>[kubernetes-실습] 간단한 application 배포, yaml템플릿, 서비스 expose 해보기</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> ps.jang </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Jan 26, 2021, 1:30 AM +0900" >Jan 26<i class="unloaded">2021-01-26T01:30:00+09:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Aug 26, 2021, 12:00 AM +0000" >Aug 26<i class="unloaded">2021-08-26T00:00:00+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2142 words">11 min read</span></div></div><div class="post-content"><h2 id="nginx-app-간단하게-배포해보기">nginx app 간단하게 배포해보기</h2><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre><span class="c"># nginx app 배포 하기</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl create deployment nginx <span class="nt">--image</span><span class="o">=</span>nginx  
deployment.apps/nginx created

<span class="c"># 현재 클러스터의 event 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get events
LAST SEEN   TYPE     REASON              OBJECT                        MESSAGE
29s         Normal   Scheduled           pod/nginx-554b9c67f9-cncvz    Successfully assigned default/nginx-554b9c67f9-cncvz to k8sworker1
27s         Normal   Pulling             pod/nginx-554b9c67f9-cncvz    Pulling image <span class="s2">"nginx"</span>
21s         Normal   Pulled              pod/nginx-554b9c67f9-cncvz    Successfully pulled image <span class="s2">"nginx"</span>
20s         Normal   Created             pod/nginx-554b9c67f9-cncvz    Created container nginx
19s         Normal   Started             pod/nginx-554b9c67f9-cncvz    Started container nginx
29s         Normal   SuccessfulCreate    replicaset/nginx-554b9c67f9   Created pod: nginx-554b9c67f9-cncvz
29s         Normal   ScalingReplicaSet   deployment/nginx              Scaled up replica <span class="nb">set </span>nginx-554b9c67f9 to 1

<span class="c"># nginx object의 자세한 정보를 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe deployment nginx
Name:                   nginx
Namespace:              default
CreationTimestamp:      Tue, 28 Jan 2020 10:10:43 +0000
Labels:                 <span class="nv">app</span><span class="o">=</span>nginx
Annotations:            deployment.kubernetes.io/revision: 1
Selector:               <span class="nv">app</span><span class="o">=</span>nginx
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  <span class="nv">app</span><span class="o">=</span>nginx
  Containers:
   nginx:
    Image:        nginx
    Port:         &lt;none&gt;
    Host Port:    &lt;none&gt;
    Environment:  &lt;none&gt;
    Mounts:       &lt;none&gt;
  Volumes:        &lt;none&gt;
Conditions:
  Type           Status  Reason
  <span class="nt">----</span>           <span class="nt">------</span>  <span class="nt">------</span>
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  &lt;none&gt;
NewReplicaSet:   nginx-554b9c67f9 <span class="o">(</span>1/1 replicas created<span class="o">)</span>
Events:
  Type    Reason             Age   From                   Message
  <span class="nt">----</span>    <span class="nt">------</span>             <span class="nt">----</span>  <span class="nt">----</span>                   <span class="nt">-------</span>
  Normal  ScalingReplicaSet  71s   deployment-controller  Scaled up replica <span class="nb">set </span>nginx-554b9c67f9 to 1
</pre></table></code></div></div><hr /><h2 id="yaml-파일-템플릿-만드는-3가지-방법">yaml 파일 템플릿 만드는 3가지 방법</h2><div class="table-wrapper"><table><tbody><tr><td>명령어<td>리소스 생성<td>설명<tr><td>$ kubectl get deployment nginx -o yaml<td>필요<td>템플릿 내용 중에서 아래 라인 삭제하여 사용 &lt;/br&gt; – createTimestamp &lt;/br&gt; – resourceVersion &lt;/br&gt; – selfLink &lt;/br&gt; – uid &lt;/br&gt; – status 포함 아래 전체<tr><td>$ kubectl get deployment nginx –export<td>필요<td>템플릿 내용 그대로 사용 가능. 필요한 부분만 수정해서 사용.<tr><td>$ kubectl create deployment nginx –dry-run<td>필요없음<td>실제 object를 생성하지 않고 yaml 파일 템플릿을 얻을 수 있음.</table></div><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
</pre><td class="rouge-code"><pre><span class="c"># -o 옵션을  nginx object의 정보를 yaml 형태로 볼수 있다</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get deployment nginx <span class="nt">-o</span> yaml 
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  annotations:
    deployment.kubernetes.io/revision: <span class="s2">"1"</span>
  creationTimestamp: <span class="s2">"2020-01-28T10:10:43Z"</span>
  generation: 1
  labels:
    app: nginx
  name: nginx
  namespace: default
  resourceVersion: <span class="s2">"8641"</span>
  selfLink: /apis/extensions/v1beta1/namespaces/default/deployments/nginx
  uid: 7de7b7fa-7897-45e8-af80-7fa18af75220
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: nginx
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    <span class="nb">type</span>: RollingUpdate
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: nginx
    spec:
      containers:
      - image: nginx
        imagePullPolicy: Always
        name: nginx
        resources: <span class="o">{}</span>
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: <span class="o">{}</span>
      terminationGracePeriodSeconds: 30
status:
  availableReplicas: 1
  conditions:
  - lastTransitionTime: <span class="s2">"2020-01-28T10:10:53Z"</span>
    lastUpdateTime: <span class="s2">"2020-01-28T10:10:53Z"</span>
    message: Deployment has minimum availability.
    reason: MinimumReplicasAvailable
    status: <span class="s2">"True"</span>
    <span class="nb">type</span>: Available
  - lastTransitionTime: <span class="s2">"2020-01-28T10:10:43Z"</span>
    lastUpdateTime: <span class="s2">"2020-01-28T10:10:53Z"</span>
    message: ReplicaSet <span class="s2">"nginx-554b9c67f9"</span> has successfully progressed.
    reason: NewReplicaSetAvailable
    status: <span class="s2">"True"</span>
    <span class="nb">type</span>: Progressing
  observedGeneration: 1
  readyReplicas: 1
  replicas: 1
  updatedReplicas: 1
  
<span class="c"># --dry-run 옵션을 사용하면 현재 object resource 가 없더라도 템플릿을 얻을수 있다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl create deployment two <span class="nt">--image</span><span class="o">=</span>nginx <span class="nt">--dry-run</span> <span class="nt">-o</span> yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: two
  name: two
spec:
  replicas: 1
  selector:
    matchLabels:
      app: two
  strategy: <span class="o">{}</span>
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: two
    spec:
      containers:
      - image: nginx
        name: nginx
        resources: <span class="o">{}</span>
status: <span class="o">{}</span>

<span class="c"># --export 옵션을 사용하여 현재 nginx 객체에서 필요없는 부분이 삭제 되어 템플릿을 보여준다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get deployments nginx <span class="nt">--export</span> <span class="nt">-o</span> yaml
Flag <span class="nt">--export</span> has been deprecated, This flag is deprecated and will be removed <span class="k">in </span>future.
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  annotations:
    deployment.kubernetes.io/revision: <span class="s2">"1"</span>
  creationTimestamp: null
  generation: 1
  labels:
    app: nginx
  name: nginx
  selfLink: /apis/extensions/v1beta1/namespaces/default/deployments/nginx
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: nginx
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    <span class="nb">type</span>: RollingUpdate
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: nginx
    spec:
      containers:
      - image: nginx
        imagePullPolicy: Always
        name: nginx
        resources: <span class="o">{}</span>
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: <span class="o">{}</span>
      terminationGracePeriodSeconds: 30
status: <span class="o">{}</span>
</pre></table></code></div></div><hr /><h2 id="nginx-app-서비스-expose-해보기">nginx app 서비스 expose 해보기</h2><ul><li>참고로 nginx expose 후 ifconfig로 인터페이스를 보면 calico 인터페이스가 두개 생성이 되는것을 볼수 있다.</ul><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre><td class="rouge-code"><pre><span class="c"># nginx 서비스 expose를 시도했으나 컨테이너 포트 미지정으로 에러 발생.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl expose deployment/nginx 
error: could not find port via <span class="nt">--port</span> flag or introspection
See kubectl expose <span class="nt">-h</span> <span class="k">for </span><span class="nb">help </span>and examples

<span class="c"># -o 옵션으로 현재 nginx 리소스의 템플릿 파일 만듬.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get deployment nginx <span class="nt">-o</span> yaml <span class="o">&gt;</span> nginx_1.yaml

<span class="c"># 만들어진 템플릿 파일에 필요 없는 부분 삭제하 아래와 같이 container port 부분 추가</span>
ps0107@k8smaster1:~<span class="nv">$ </span>vi nginx_1.yaml
....
   spec:
      containers:
      - image: nginx
        imagePullPolicy: Always
        name: nginx
        ports:
        - containerPort: 80
          protocol: TCP
        resources: <span class="o">{}</span>
....

<span class="c"># 수정된 yaml 파일로 nginx update</span>
<span class="c"># replace 옵션: 해당 yaml 파일에 내용으로 전체 update, 새로운 deployment를 생성하고 기존 것을 terminate 시킴</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl replace <span class="nt">-f</span> nginx_1.yaml 
deployment.extensions/nginx replaced

<span class="c"># AGE 부분 보면 새로 생성된거 확인이 가능하다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get deployment,pod
NAME                          READY   UP-TO-DATE   AVAILABLE   AGE
deployment.extensions/nginx   1/1     1            1           49m

NAME                         READY   STATUS    RESTARTS   AGE
pod/nginx-7bffc778db-6bhr6   1/1     Running   0          2m9s

<span class="c"># 다시 서비스 expose 해본다. 이번에 정상적으로 됐다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl expose deployment/nginx
service/nginx exposed

<span class="c"># nginx svc 조회</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get svc nginx
NAME    TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
nginx   ClusterIP   10.97.139.18   &lt;none&gt;        80/TCP    13s

<span class="c"># nginx endpoint 조회 (endpoint는 pod ip + container port)</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get ep nginx
NAME    ENDPOINTS        AGE
nginx   192.168.1.3:80   25s

<span class="c"># nginx cluster ip로 curl 테스트</span>
ps0107@k8smaster1:~<span class="nv">$ </span>curl 10.97.139.18:80
Welcome to nginx!

<span class="c"># nginx endpoint 로 curl 테스트</span>
ps0107@k8smaster1:~<span class="nv">$ </span>curl 192.168.1.3:80
Welcome to nginx!
</pre></table></code></div></div><hr /><h2 id="nginx-web-server를-scale-out-해보기">nginx web server를 scale out 해보기</h2><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="c"># replicas를 3으로 조정</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl scale deployment nginx <span class="nt">--replicas</span><span class="o">=</span>3
deployment.extensions/nginx scaled

<span class="c"># 3개의 pod가 생성된것을 확인할 수 있다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get deployment nginx         
NAME    READY   UP-TO-DATE   AVAILABLE   AGE
nginx   3/3     3            3           15h

<span class="c"># endpoint도 pod 갯수대로 생성이 되었다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get ep nginx        
NAME    ENDPOINTS                                       AGE
nginx   192.168.0.10:80,192.168.1.3:80,192.168.1.4:80   14h

<span class="c"># 3개의 pod정보를 확인할 수 있다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get po <span class="nt">-o</span> wide
NAME                     READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES
nginx-7bffc778db-4zbb2   1/1     Running   0          42s   192.168.1.4    k8sworker1   &lt;none&gt;           &lt;none&gt;
nginx-7bffc778db-6bhr6   1/1     Running   0          14h   192.168.1.3    k8sworker1   &lt;none&gt;           &lt;none&gt;
nginx-7bffc778db-zvlft   1/1     Running   0          42s   192.168.0.10   k8smaster1   &lt;none&gt;           &lt;none&gt;

<span class="c"># 예전에 생성된거 1개 제외하고 2개가 추가로 생성되었다. 예전에 생성된 pod를 삭제해 보자.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete po nginx-7bffc778db-6bhr6 
pod <span class="s2">"nginx-7bffc778db-6bhr6"</span> deleted

<span class="c"># pod가 새로 생성이 되었다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get po <span class="nt">-o</span> wide                   
NAME                     READY   STATUS    RESTARTS   AGE     IP             NODE         NOMINATED NODE   READINESS GATES
nginx-7bffc778db-4zbb2   1/1     Running   0          2m45s   192.168.1.4    k8sworker1   &lt;none&gt;           &lt;none&gt;
nginx-7bffc778db-svxw2   1/1     Running   0          29s     192.168.1.5    k8sworker1   &lt;none&gt;           &lt;none&gt;
nginx-7bffc778db-zvlft   1/1     Running   0          2m45s   192.168.0.10   k8smaster1   &lt;none&gt;           &lt;none&gt;

<span class="c"># endpoint도 새로 생성된걸 확인 할 수있다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get ep nginx 
NAME    ENDPOINTS                                       AGE
nginx   192.168.0.10:80,192.168.1.4:80,192.168.1.5:80   14h

<span class="c"># cluster ip로 curl 테스트 해보면 3개의 pod로 분산되어 들어간다.</span>
</pre></table></code></div></div><hr /><h2 id="클러스터-외부에서-접근할-수-있도록-설정해보기">클러스터 외부에서 접근할 수 있도록 설정해보기</h2><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="c"># 현재 pod 정보</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get po
NAME                     READY   STATUS    RESTARTS   AGE
nginx-7bffc778db-4zbb2   1/1     Running   0          37m
nginx-7bffc778db-svxw2   1/1     Running   0          35m
nginx-7bffc778db-zvlft   1/1     Running   0          37m

<span class="c"># pod 안에 환경설정 정보를 확인해본다 (KUBERNETES란 네이밍이 들어간 것만)</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl <span class="nb">exec </span>nginx-7bffc778db-4zbb2 <span class="nt">--</span> <span class="nb">printenv</span> | <span class="nb">grep </span>KUBERNETES
<span class="nv">KUBERNETES_PORT_443_TCP_ADDR</span><span class="o">=</span>10.96.0.1   
<span class="nv">KUBERNETES_PORT_443_TCP_PORT</span><span class="o">=</span>443     
<span class="nv">KUBERNETES_SERVICE_HOST</span><span class="o">=</span>10.96.0.1   
<span class="nv">KUBERNETES_SERVICE_PORT_HTTPS</span><span class="o">=</span>443   
<span class="nv">KUBERNETES_PORT_443_TCP</span><span class="o">=</span>tcp://10.96.0.1:443   
<span class="nv">KUBERNETES_PORT</span><span class="o">=</span>tcp://10.96.0.1:443          
<span class="nv">KUBERNETES_SERVICE_PORT</span><span class="o">=</span>443       
<span class="nv">KUBERNETES_PORT_443_TCP_PROTO</span><span class="o">=</span>tcp       

<span class="c"># 현재 svc 정보 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get svc
NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
kubernetes   ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP   17h
nginx        ClusterIP   10.97.139.18   &lt;none&gt;        80/TCP    14h

<span class="c"># nginx svc 리소스를 삭제 해준다. 다시 생성하기 위해서.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete svc nginx 
service <span class="s2">"nginx"</span> deleted

<span class="c"># 이번엔 LoadBalancer 타입으로 생성해준다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl expose deployment nginx <span class="nt">--type</span><span class="o">=</span>LoadBalancer 
service/nginx exposed

<span class="c"># 생성된 것을 확인할 수 있다. </span>
<span class="c"># 참고로 external-ip는 eks 같은 클라우드 서비스를 쓸 경우 elb 주소가 들어간다.</span>
<span class="c"># 현재는 없으므로 pending 상태이다. 대신 node port 하나가 생성되었다 (31325 port)</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get svc
NAME         TYPE           CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE
kubernetes   ClusterIP      10.96.0.1        &lt;none&gt;        443/TCP        17h
nginx        LoadBalancer   10.103.105.106   &lt;pending&gt;     80:31325/TCP   8s
</pre></table></code></div></div><ul><li>웹브라우저를 통해서 http://{노드아이피}:{노드포트} 로 접속하면 nginx 화면을 볼수 있다. 3개의 pod로 분산되어 들어가게 된다. replicas를 0으로 해서 다시 접속하면 웹접속은 실패할 것이다. 실습 후 이제 리소스를 정리해본다. 상위 객체 삭제시 하위객체까지 삭제되고, 하위 객체 삭제시 상위객체는 남아 있게 된다.</ul><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete deployments nginx 
deployment.extensions <span class="s2">"nginx"</span> deleted

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete ep nginx  
endpoints <span class="s2">"nginx"</span> deleted

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete svc nginx 
service <span class="s2">"nginx"</span> deleted
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kubernetes/'>Kubernetes</a>, <a href='/categories/kubernetes-administration-course/'>Kubernetes Administration Course</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >kubernetes</a> <a href="/tags/cka/" class="post-tag no-text-decoration" >cka</a> <a href="/tags/lfs458/" class="post-tag no-text-decoration" >LFS458</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[kubernetes-실습] 간단한 application 배포, yaml템플릿, 서비스 expose 해보기 - ps's Blog&url=https://ps2046.github.io/posts/03.deployment_yaml_service/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[kubernetes-실습] 간단한 application 배포, yaml템플릿, 서비스 expose 해보기 - ps's Blog&u=https://ps2046.github.io/posts/03.deployment_yaml_service/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=[kubernetes-실습] 간단한 application 배포, yaml템플릿, 서비스 expose 해보기 - ps's Blog&url=https://ps2046.github.io/posts/03.deployment_yaml_service/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/blog-comments-utterances/">[blog] github blog comments (utterances)</a><li><a href="/posts/17.kubernetes_Scheduling_2/">[kubernetes-실습] Scheduling - Taint를 이용한 pod 배포 관리</a><li><a href="/posts/18.kubernetes_logging_trubleshooting_1/">[kubernetes-실습] 로깅과 트러블슈팅 : 로그위치와 로그 출력 보기</a><li><a href="/posts/19.kubernetes_logging_trubleshooting_2/">[kubernetes-실습] 로깅과 트러블슈팅 : Metrics와 DashBoard</a><li><a href="/posts/20.kubernetes_crd/">[kubernetes-실습] CRD (Custom Resource Definition)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cka/">cka</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/lfs458/">LFS458</a> <a class="post-tag" href="/tags/bash/">bash</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/comments/">comments</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/monitoring/">monitoring</a> <a class="post-tag" href="/tags/system/">system</a> <a class="post-tag" href="/tags/utterances/">utterances</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/17.kubernetes_Scheduling_2/"><div class="card-body"> <span class="timeago small" >Jan 26<i class="unloaded">2021-01-26T08:30:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[kubernetes-실습] Scheduling - Taint를 이용한 pod 배포 관리</h3><div class="text-muted small"><p> Using Taints to Control Pod Deployment taints를 사용하여 어느곳에 pod가 배치되거나 실행을 허용하도록 관리할수 있다. 노드 그룹에 pod들을 할당하여 추가할때 노드 사용을 제한하거나 pod들을 완전히 대피시킬수 있다. 참고 마스터노드가 처음에 NoSchedule taint로 설정되어 있었던것을 기억할 것이다...</p></div></div></a></div><div class="card"> <a href="/posts/18.kubernetes_logging_trubleshooting_1/"><div class="card-body"> <span class="timeago small" >Jan 26<i class="unloaded">2021-01-26T09:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[kubernetes-실습] 로깅과 트러블슈팅 : 로그위치와 로그 출력 보기</h3><div class="text-muted small"><p> 로그 파일들의 위치 알아보기 다양한 로그 파일과 명령 출력 이외에도 journalctl을 사용하여 노드 관점에서 로그를 볼 수 있다. 우리는 로그 파일의 공통적인 위치를 보고, 컨테이너 로그를 보는 명령을 볼 것이다. 다른 컨테이너의 로그를 pod에 적재하는데 전용으로 사용되는 sidecar container의 사용과 같은 다른 로깅 ...</p></div></div></a></div><div class="card"> <a href="/posts/19.kubernetes_logging_trubleshooting_2/"><div class="card-body"> <span class="timeago small" >Jan 26<i class="unloaded">2021-01-26T10:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[kubernetes-실습] 로깅과 트러블슈팅 : Metrics와 DashBoard</h3><div class="text-muted small"><p> Metrics 설정 heapster가 deprecation 되면서 Metrics Server 와 통합되어 개발되고 배포되어지고 있다. 그리고 CNCF의 프로젝트중 프로메테우스도 잘 사용되어지고 있다. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 3...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/02.kubernetes_cluster_node_setting/" class="btn btn-outline-primary" prompt="Older"><p>[kubernetes-실습] 쿠버네티스 클러스트 노드 확장 및 셋팅</p></a> <a href="/posts/04.kubernetes_deployment_CPU_Memory/" class="btn btn-outline-primary" prompt="Newer"><p>[kubernetes-실습] deployment 의 CPU, Memory 제약</p></a></div><script src="https://utteranc.es/client.js" repo="ps2046/ps2046-github-io-comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async> </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://ps2046.github.io">ps.jang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/cka/">cka</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/lfs458/">LFS458</a> <a class="post-tag" href="/tags/bash/">bash</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/comments/">comments</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/monitoring/">monitoring</a> <a class="post-tag" href="/tags/system/">system</a> <a class="post-tag" href="/tags/utterances/">utterances</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ps2046.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-158837927-2"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-158837927-2'); }); </script>
