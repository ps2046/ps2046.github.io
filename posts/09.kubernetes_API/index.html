<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="[kubernetes-실습] API 객체" /><meta property="og:locale" content="en" /><meta name="description" content="kubernetes 인증 시험(CKA)에 대비하기 위해 실습을 해보도록 한다." /><meta property="og:description" content="kubernetes 인증 시험(CKA)에 대비하기 위해 실습을 해보도록 한다." /><link rel="canonical" href="https://ps2046.github.io/posts/09.kubernetes_API/" /><meta property="og:url" content="https://ps2046.github.io/posts/09.kubernetes_API/" /><meta property="og:site_name" content="ps’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-26T04:30:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[kubernetes-실습] API 객체" /><meta name="twitter:site" content="@ps2046" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"kubernetes 인증 시험(CKA)에 대비하기 위해 실습을 해보도록 한다.","headline":"[kubernetes-실습] API 객체","dateModified":"2021-08-26T00:00:00+09:00","url":"https://ps2046.github.io/posts/09.kubernetes_API/","datePublished":"2021-01-26T04:30:00+09:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ps2046.github.io/posts/09.kubernetes_API/"},"@context":"https://schema.org"}</script><title>[kubernetes-실습] API 객체 | ps's Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ps's Blog"><meta name="application-name" content="ps's Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7635228999568716" crossorigin="anonymous"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/11029548?s=400&u=5ebc191faa53e931968ec2ed98bd7c7b68136c71&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ps's Blog</a></div><div class="site-subtitle font-italic">System Engineer & Developer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ps2046" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/ps2046" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ps2046.jang','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[kubernetes-실습] API 객체</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>[kubernetes-실습] API 객체</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> ps.jang </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Jan 26, 2021, 4:30 AM +0900" >Jan 26<i class="unloaded">2021-01-26T04:30:00+09:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Aug 26, 2021, 12:00 AM +0000" >Aug 26<i class="unloaded">2021-08-26T00:00:00+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3211 words">17 min read</span></div></div><div class="post-content"><h2 id="restful-api-access-토큰-기반-리소스-접근-namespace별-토큰-생성">RESTful API Access (토큰 기반 리소스 접근, namespace별 토큰 생성)</h2><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
</pre><td class="rouge-code"><pre><span class="c"># api server의 node의 ip와 port 확인</span>
<span class="c"># 클러스트 설정 정보 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl config view
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: DATA+OMITTED
    server: https://k8smaster:6443
  name: kubernetes
contexts:
- context:
    cluster: kubernetes
    user: kubernetes-admin
  name: kubernetes-admin@kubernetes
current-context: kubernetes-admin@kubernetes
kind: Config
preferences: <span class="o">{}</span>
<span class="nb">users</span>:
- name: kubernetes-admin
  user:
    client-certificate-data: REDACTED
    client-key-data: REDACTED

<span class="c"># bearer token 확인 필요</span>
<span class="c"># secrets : volume 리소스 유형중 하나 (크리티컬한 정보들도 pod간 공유, 자동 인코딩 되어 저장)    </span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get secrets <span class="nt">--all-namespaces</span>
NAMESPACE         NAME                                             TYPE                                  DATA   AGE
default           default-token-76w5h                              kubernetes.io/service-account-token   3      5d3h
kube-node-lease   default-token-868ws                              kubernetes.io/service-account-token   3      5d3h
kube-public       default-token-vrv96                              kubernetes.io/service-account-token   3      5d3h
kube-system       attachdetach-controller-token-q6gnc              kubernetes.io/service-account-token   3      5d3h
kube-system       bootstrap-signer-token-52n72                     kubernetes.io/service-account-token   3      5d3h
kube-system       bootstrap-token-jaeaqt                           bootstrap.kubernetes.io/token         6      5d3h
kube-system       bootstrap-token-qa1m8y                           bootstrap.kubernetes.io/token         4      5d3h
kube-system       calico-node-token-9d74h                          kubernetes.io/service-account-token   3      5d3h
kube-system       certificate-controller-token-scw76               kubernetes.io/service-account-token   3      5d3h
kube-system       clusterrole-aggregation-controller-token-bzb8m   kubernetes.io/service-account-token   3      5d3h
kube-system       coredns-token-cmpj6                              kubernetes.io/service-account-token   3      5d3h
kube-system       cronjob-controller-token-rdp76                   kubernetes.io/service-account-token   3      5d3h
kube-system       daemon-set-controller-token-zrfl2                kubernetes.io/service-account-token   3      5d3h
kube-system       default-token-9xjr8                              kubernetes.io/service-account-token   3      5d3h
kube-system       deployment-controller-token-dghwg                kubernetes.io/service-account-token   3      5d3h
kube-system       disruption-controller-token-s5rdz                kubernetes.io/service-account-token   3      5d3h
kube-system       endpoint-controller-token-fk4gw                  kubernetes.io/service-account-token   3      5d3h
kube-system       expand-controller-token-xqdz5                    kubernetes.io/service-account-token   3      5d3h
kube-system       generic-garbage-collector-token-gg8l7            kubernetes.io/service-account-token   3      5d3h
kube-system       horizontal-pod-autoscaler-token-5xjpz            kubernetes.io/service-account-token   3      5d3h
kube-system       job-controller-token-ndn45                       kubernetes.io/service-account-token   3      5d3h
kube-system       kube-proxy-token-7jjl9                           kubernetes.io/service-account-token   3      5d3h
kube-system       kubeadm-certs                                    Opaque                                8      5d3h
kube-system       namespace-controller-token-z7vnn                 kubernetes.io/service-account-token   3      5d3h
kube-system       node-controller-token-jgg7f                      kubernetes.io/service-account-token   3      5d3h
kube-system       persistent-volume-binder-token-7qksk             kubernetes.io/service-account-token   3      5d3h
kube-system       pod-garbage-collector-token-9bgvk                kubernetes.io/service-account-token   3      5d3h
kube-system       pv-protection-controller-token-7nbqk             kubernetes.io/service-account-token   3      5d3h
kube-system       pvc-protection-controller-token-zssxk            kubernetes.io/service-account-token   3      5d3h
kube-system       replicaset-controller-token-59szg                kubernetes.io/service-account-token   3      5d3h
kube-system       replication-controller-token-5j78s               kubernetes.io/service-account-token   3      5d3h
kube-system       resourcequota-controller-token-95qgb             kubernetes.io/service-account-token   3      5d3h
kube-system       service-account-controller-token-d4fmk           kubernetes.io/service-account-token   3      5d3h
kube-system       service-controller-token-wbbpt                   kubernetes.io/service-account-token   3      5d3h
kube-system       statefulset-controller-token-hsk8b               kubernetes.io/service-account-token   3      5d3h
kube-system       token-cleaner-token-v8r9r                        kubernetes.io/service-account-token   3      5d3h
kube-system       ttl-controller-token-tjbl4                       kubernetes.io/service-account-token   3      5d3h
sock-shop         default-token-fjxvf                              kubernetes.io/service-account-token   3      3d6h

<span class="c"># default namespace 인것 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get secrets
NAME                  TYPE                                  DATA   AGE
default-token-76w5h   kubernetes.io/service-account-token   3      5d3h

<span class="c"># 해당 secret에 있는 token 정보 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe secret default-token-76w5h
Name:         default-token-76w5h
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  kubernetes.io/service-account.name: default
              kubernetes.io/service-account.uid: d063e90a-2b41-43a9-88c2-9e4e3e8839c9

Type:  kubernetes.io/service-account-token

Data
<span class="o">====</span>
namespace:  7 bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tNzZ3NWgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImQwNjNlOTBhLTJiNDEtNDNhOS04OGMyLTllNGUzZTg4MzljOSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.lLz_lHjoBNnzTsNQR4x8r7s2saIqVCRM1emPUjio9PyNXd02zHs9l-jGQS3PnvX1FyyK1eYHYUuk6OibR5MZqHJEblz22xjI1alniVVwAAxh3r7PmoQXdbYnLUZYxqu2XKc1XkWlnDK1TQmU6zMc0oUYLjsIYjrC0FZ7l8dju3dx3rlpVA9qD7nq1obmwGHKg7ItJW2s5od1DXKJfOo3Li4P5PVmfUR-VDVCR5glPUXS_jWfQp9FmMxWKfI95b-vzjNNYI-rzbBrHWqY_DN6c9Qm2eQsHKo7r5DT8XPKLv-wyH5RD1glqMcOwM8BObsJDjfamRp9cjS37FrEIDQqkw
ca.crt:     1025 bytes


<span class="c"># token 정보를 변수에 export하여 저장</span>
ps0107@k8smaster1:~<span class="nv">$ </span><span class="nb">export </span><span class="nv">token</span><span class="o">=</span><span class="si">$(</span>kubectl describe secret default-token-76w5h | <span class="nb">grep</span> ^token | <span class="nb">cut</span> <span class="nt">-f7</span> <span class="nt">-d</span> <span class="s1">' '</span><span class="si">)</span>

<span class="c"># -k 옵션은 인증없이 사용한다</span>
ps0107@k8smaster1:~<span class="nv">$ </span>curl https://k8smaster:6443/apis <span class="nt">--header</span> <span class="s2">"Authorization: Bearer </span><span class="nv">$token</span><span class="s2">"</span> <span class="nt">-k</span>
<span class="o">{</span>
  <span class="s2">"kind"</span>: <span class="s2">"APIGroupList"</span>,
  <span class="s2">"apiVersion"</span>: <span class="s2">"v1"</span>,
  <span class="s2">"groups"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"apiregistration.k8s.io"</span>,
      <span class="s2">"versions"</span>: <span class="o">[</span>
        <span class="o">{</span>
          <span class="s2">"groupVersion"</span>: <span class="s2">"apiregistration.k8s.io/v1"</span>,
          <span class="s2">"version"</span>: <span class="s2">"v1"</span>
        <span class="o">}</span>,
        <span class="o">{</span>
          <span class="s2">"groupVersion"</span>: <span class="s2">"apiregistration.k8s.io/v1beta1"</span>,
          <span class="s2">"version"</span>: <span class="s2">"v1beta1"</span>
        <span class="o">}</span>
      <span class="o">]</span>,
      <span class="s2">"preferredVersion"</span>: <span class="o">{</span>
        <span class="s2">"groupVersion"</span>: <span class="s2">"apiregistration.k8s.io/v1"</span>,
        <span class="s2">"version"</span>: <span class="s2">"v1"</span>
      <span class="o">}</span>
    <span class="o">}</span>,
.......

<span class="c"># 해당 토큰은 namespace의 권한이 없기 때문에 403 에러가 발생한다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>curl https://k8smaster:6443/api/v1/namespaces <span class="nt">--header</span> <span class="s2">"Authorization: Bearer </span><span class="nv">$token</span><span class="s2">"</span> <span class="nt">-k</span>
<span class="o">{</span>
  <span class="s2">"kind"</span>: <span class="s2">"Status"</span>,
  <span class="s2">"apiVersion"</span>: <span class="s2">"v1"</span>,
  <span class="s2">"metadata"</span>: <span class="o">{</span>

  <span class="o">}</span>,
  <span class="s2">"status"</span>: <span class="s2">"Failure"</span>,
  <span class="s2">"message"</span>: <span class="s2">"namespaces is forbidden: User </span><span class="se">\"</span><span class="s2">system:serviceaccount:default:default</span><span class="se">\"</span><span class="s2"> cannot list resource </span><span class="se">\"</span><span class="s2">namespaces</span><span class="se">\"</span><span class="s2"> in API group </span><span class="se">\"\"</span><span class="s2"> at the cluster scope"</span>,
  <span class="s2">"reason"</span>: <span class="s2">"Forbidden"</span>,
  <span class="s2">"details"</span>: <span class="o">{</span>
    <span class="s2">"kind"</span>: <span class="s2">"namespaces"</span>
  <span class="o">}</span>,
  <span class="s2">"code"</span>: 403
<span class="o">}</span>

<span class="c"># namespace별 할당된 토큰이 pod가 런칭되었얼때 해당 토큰을 사용한다.</span>
<span class="c"># pod의 /var/run/secrets/kubernetes.io/serviceaccount/ 경로로 마운트 된것을 볼수 있다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl run <span class="nt">-it</span> busybox <span class="nt">--image</span><span class="o">=</span>busybox <span class="nt">--restart</span><span class="o">=</span>Never
If you don<span class="s1">'t see a command prompt, try pressing enter.
/ # cd /var/run/secrets/kubernetes.io/serviceaccount/
/ # ls 
ca.crt     namespace  token
/ # cat token
eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tNzZ3NWgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6ImQwNjNlOTBhLTJiNDEtNDNhOS04OGMyLTllNGUzZTg4MzljOSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.lLz_lHjoBNnzTsNQR4x8r7s2saIqVCRM1emPUjio9PyNXd02zHs9l-jGQS3PnvX1FyyK1eYHYUuk6OibR5MZqHJEblz22xjI1alniVVwAAxh3r7PmoQXdbYnLUZYxqu2XKc1XkWlnDK1TQmU6zMc0oUYLjsIYjrC0FZ7l8dju3dx3rlpVA9qD7nq1obmwGHKg7ItJW2s5od1DXKJfOo3Li4P5PVmfUR-VDVCR5glPUXS_jWfQp9FmMxWKfI95b-vzjNNYI-rzbBrHWqY_DN6c9Qm2eQsHKo7r5DT8XPKLv-wyH5RD1glqMcOwM8BObsJDjfamRp9cjS37FrEIDQqkw
/ # exit
</span></pre></table></code></div></div><hr /><h2 id="참고">참고</h2><ul><li>–restart={옵션}</ul><ol><li><p>Always : deployment 객체로 생성</p><li><p>Never : 단순 pod로 배포</p><li><p>Onfailure : Job기반</p></ol><hr /><h2 id="proxy-사용해-보기">Proxy 사용해 보기</h2><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
</pre><td class="rouge-code"><pre><span class="c"># proxy 도움페이지 보기</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl proxy <span class="nt">-h</span>
Creates a proxy server or application-level gateway between localhost and the Kubernetes API Server. It also allows
serving static content over specified HTTP path. All incoming data enters through one port and gets forwarded to the
remote kubernetes API Server port, except <span class="k">for </span>the path matching the static content path.

Examples:
  <span class="c"># To proxy all of the kubernetes api and nothing else, use:</span>

  <span class="nv">$ </span>kubectl proxy <span class="nt">--api-prefix</span><span class="o">=</span>/

  <span class="c"># To proxy only part of the kubernetes api and also some static files:</span>

  <span class="nv">$ </span>kubectl proxy <span class="nt">--www</span><span class="o">=</span>/my/files <span class="nt">--www-prefix</span><span class="o">=</span>/static/ <span class="nt">--api-prefix</span><span class="o">=</span>/api/

  <span class="c"># The above lets you 'curl localhost:8001/api/v1/pods'.</span>

  <span class="c"># To proxy the entire kubernetes api at a different root, use:</span>

  <span class="nv">$ </span>kubectl proxy <span class="nt">--api-prefix</span><span class="o">=</span>/custom/

  <span class="c"># The above lets you 'curl localhost:8001/custom/api/v1/pods'</span>

  <span class="c"># Run a proxy to kubernetes apiserver on port 8011, serving static content from ./local/www/</span>
  kubectl proxy <span class="nt">--port</span><span class="o">=</span>8011 <span class="nt">--www</span><span class="o">=</span>./local/www/

  <span class="c"># Run a proxy to kubernetes apiserver on an arbitrary local port.</span>
  <span class="c"># The chosen port for the server will be output to stdout.</span>
  kubectl proxy <span class="nt">--port</span><span class="o">=</span>0

  <span class="c"># Run a proxy to kubernetes apiserver, changing the api prefix to k8s-api</span>
  <span class="c"># This makes e.g. the pods api available at localhost:8001/k8s-api/v1/pods/</span>
  kubectl proxy <span class="nt">--api-prefix</span><span class="o">=</span>/k8s-api

Options:
      <span class="nt">--accept-hosts</span><span class="o">=</span><span class="s1">'^localhost$,^127\.0\.0\.1$,^\[::1\]$'</span>: Regular expression <span class="k">for </span>hosts that the proxy should accept.
      <span class="nt">--accept-paths</span><span class="o">=</span><span class="s1">'^.*'</span>: Regular expression <span class="k">for </span>paths that the proxy should accept.
      <span class="nt">--address</span><span class="o">=</span><span class="s1">'127.0.0.1'</span>: The IP address on which to serve on.
      <span class="nt">--api-prefix</span><span class="o">=</span><span class="s1">'/'</span>: Prefix to serve the proxied API under.
      <span class="nt">--disable-filter</span><span class="o">=</span><span class="nb">false</span>: If <span class="nb">true</span>, disable request filtering <span class="k">in </span>the proxy. This is dangerous, and can leave you
vulnerable to XSRF attacks, when used with an accessible port.
      <span class="nt">--keepalive</span><span class="o">=</span>0s: keepalive specifies the keep-alive period <span class="k">for </span>an active network connection. Set to 0 to disable
keepalive.
  <span class="nt">-p</span>, <span class="nt">--port</span><span class="o">=</span>8001: The port on which to run the proxy. Set to 0 to pick a random port.
      <span class="nt">--reject-methods</span><span class="o">=</span><span class="s1">'^$'</span>: Regular expression <span class="k">for </span>HTTP methods that the proxy should reject <span class="o">(</span>example
<span class="nt">--reject-methods</span><span class="o">=</span><span class="s1">'POST,PUT,PATCH'</span><span class="o">)</span><span class="nb">.</span>
      <span class="nt">--reject-paths</span><span class="o">=</span><span class="s1">'^/api/.*/pods/.*/exec,^/api/.*/pods/.*/attach'</span>: Regular expression <span class="k">for </span>paths that the proxy should
reject. Paths specified here will be rejected even accepted by <span class="nt">--accept-paths</span><span class="nb">.</span>
  <span class="nt">-u</span>, <span class="nt">--unix-socket</span><span class="o">=</span><span class="s1">''</span>: Unix socket on which to run the proxy.
  <span class="nt">-w</span>, <span class="nt">--www</span><span class="o">=</span><span class="s1">''</span>: Also serve static files from the given directory under the specified prefix.
  <span class="nt">-P</span>, <span class="nt">--www-prefix</span><span class="o">=</span><span class="s1">'/static/'</span>: Prefix to serve static files under, <span class="k">if </span>static file directory is specified.

Usage:
  kubectl proxy <span class="o">[</span><span class="nt">--port</span><span class="o">=</span>PORT] <span class="o">[</span><span class="nt">--www</span><span class="o">=</span>static-dir] <span class="o">[</span><span class="nt">--www-prefix</span><span class="o">=</span>prefix] <span class="o">[</span><span class="nt">--api-prefix</span><span class="o">=</span>prefix] <span class="o">[</span>options]

Use <span class="s2">"kubectl options"</span> <span class="k">for </span>a list of global command-line options <span class="o">(</span>applies to all commands<span class="o">)</span><span class="nb">.</span>

<span class="c"># 인증 생략 하여 api 사용 (내부 전송이라 인증이 필요 없음)</span>
<span class="c"># background 로 실행 되고 api prefix 세팅</span>
<span class="c"># 주로 개발자가 로컬에서 테스트하기 위해 endpoint 제공(인증 방식이 아니라 간단하게 사용 가능하다)</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl proxy <span class="nt">--api-prefix</span><span class="o">=</span>/ &amp;
<span class="o">[</span>1] 16218
ps0107@k8smaster1:~<span class="nv">$ </span>Starting to serve on 127.0.0.1:8001

<span class="c"># http://127.0.0.1:8001/ 로 테스트 가능</span>
ps0107@k8smaster1:~<span class="nv">$ </span>curl http://127.0.0.1:8001/api/
<span class="o">{</span>
  <span class="s2">"kind"</span>: <span class="s2">"APIVersions"</span>,
  <span class="s2">"versions"</span>: <span class="o">[</span>
    <span class="s2">"v1"</span>
  <span class="o">]</span>,
  <span class="s2">"serverAddressByClientCIDRs"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"clientCIDR"</span>: <span class="s2">"0.0.0.0/0"</span>,
      <span class="s2">"serverAddress"</span>: <span class="s2">"10.146.0.2:6443"</span>
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>

ps0107@k8smaster1:~<span class="nv">$ </span> curl http://127.0.0.1:8001/api/v1/namespaces
<span class="o">{</span>
  <span class="s2">"kind"</span>: <span class="s2">"NamespaceList"</span>,
  <span class="s2">"apiVersion"</span>: <span class="s2">"v1"</span>,
  <span class="s2">"metadata"</span>: <span class="o">{</span>
    <span class="s2">"selfLink"</span>: <span class="s2">"/api/v1/namespaces"</span>,
    <span class="s2">"resourceVersion"</span>: <span class="s2">"606177"</span>
  <span class="o">}</span>,
  <span class="s2">"items"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"metadata"</span>: <span class="o">{</span>
        <span class="s2">"name"</span>: <span class="s2">"default"</span>,
        <span class="s2">"selfLink"</span>: <span class="s2">"/api/v1/namespaces/default"</span>,
        <span class="s2">"uid"</span>: <span class="s2">"d001f113-42a9-49b6-ad1c-5dfdc9ce66fc"</span>,
        <span class="s2">"resourceVersion"</span>: <span class="s2">"149"</span>,
        <span class="s2">"creationTimestamp"</span>: <span class="s2">"2020-01-28T08:29:32Z"</span>
      <span class="o">}</span>,
      <span class="s2">"spec"</span>: <span class="o">{</span>
        <span class="s2">"finalizers"</span>: <span class="o">[</span>
          <span class="s2">"kubernetes"</span>
        <span class="o">]</span>
      <span class="o">}</span>,
      <span class="s2">"status"</span>: <span class="o">{</span>
        <span class="s2">"phase"</span>: <span class="s2">"Active"</span>
      <span class="o">}</span>
    <span class="o">}</span>,
   .......
</pre></table></code></div></div><hr /><h2 id="job-사용">Job 사용</h2><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
</pre><td class="rouge-code"><pre><span class="c"># ------------------------------------------------</span>
<span class="c"># 파라메터 설정 없이 기본 값으로 job 사용</span>
<span class="c"># ------------------------------------------------</span>
<span class="c"># restartPolicy 옵션</span>
<span class="c"># - Always : deployment 객체로 생성</span>
<span class="c"># - Never : 단순 Pod로 배포</span>
<span class="c"># - Onfailure : Job기반</span>
ps0107@k8smaster1:~<span class="nv">$ </span>vi job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: sleepy
spec:
  template:
    spec:
      containers:
      - name: resting
        image: busybox
        <span class="nb">command</span>: <span class="o">[</span><span class="s2">"/bin/sleep"</span><span class="o">]</span>
        args: <span class="o">[</span><span class="s2">"3"</span><span class="o">]</span>
      restartPolicy: Never <span class="c">#-&gt; 원래는 OnFailure : 한번의 success를 보장. 중간에 장애 발생시 재시작</span>

<span class="c"># job 생성      </span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl create <span class="nt">-f</span> job.yaml
job.batch/sleepy created

<span class="c"># 생성된 job 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get job
NAME     COMPLETIONS   DURATION   AGE
sleepy   0/1           6s         6s

<span class="c"># job 상세 확인</span>
<span class="c"># Parallelism, Completions은 디폴트 값</span>
<span class="c"># Pods Statuses 확인 해보면 1번 Success 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe jobs.batch sleepy
Name:           sleepy
Namespace:      default
Selector:       controller-uid<span class="o">=</span>138bbff0-02ae-45a5-bc7f-335125602d16
Labels:         controller-uid<span class="o">=</span>138bbff0-02ae-45a5-bc7f-335125602d16
                job-name<span class="o">=</span>sleepy
Annotations:    &lt;none&gt;
Parallelism:    1  <span class="c"># -&gt; 기본값</span>
Completions:    1  <span class="c"># -&gt; 기본값</span>
Start Time:     Sun, 02 Feb 2020 14:09:21 +0000
Completed At:   Sun, 02 Feb 2020 14:09:29 +0000
Duration:       8s
Pods Statuses:  0 Running / 1 Succeeded / 0 Failed. <span class="c"># -&gt; 성공 1회</span>
.....

<span class="c"># 생성된 job 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get job
NAME     COMPLETIONS   DURATION   AGE
sleepy   1/1           8s         51s

<span class="c"># job 오브젝트 yaml 확인</span>
<span class="c"># spec 부분에 backoffLimit, completions, parallelism 파라메터 확인 가능.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get jobs.batch sleepy <span class="nt">-o</span> yaml
......
  uid: 138bbff0-02ae-45a5-bc7f-335125602d16
spec:
  backoffLimit: 6
  completions: 1
  parallelism: 1
  selector:
    matchLabels:
      controller-uid: 138bbff0-02ae-45a5-bc7f-335125602d16
......

<span class="c"># 생성한 오브젝트 삭제</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete jobs.batch sleepy
job.batch <span class="s2">"sleepy"</span> deleted

<span class="c"># ------------------------------------------------</span>
<span class="c"># completions 파라메터 설정 해보기</span>
<span class="c"># ------------------------------------------------</span>
ps0107@k8smaster1:~<span class="nv">$ </span>vi job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: sleepy
spec:
  completions: 5 <span class="c"># -&gt; 추가</span>
  template:
    spec:
      containers:
      - name: resting
        image: busybox
        <span class="nb">command</span>: <span class="o">[</span><span class="s2">"/bin/sleep"</span><span class="o">]</span>
        args: <span class="o">[</span><span class="s2">"3"</span><span class="o">]</span>
      restartPolicy: Never

<span class="c"># job 오브젝트 생성</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl create <span class="nt">-f</span> job.yaml
job.batch/sleepy created

<span class="c"># job 배치 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get jobs.batch
NAME     COMPLETIONS   DURATION   AGE
sleepy   1/5           7s         7s

<span class="c"># pod 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get pods
NAME           READY   STATUS      RESTARTS   AGE
sleepy-94mw8   1/1     Running     0          4s
sleepy-cl8px   0/1     Completed   0          18s
sleepy-pffgc   0/1     Completed   0          11s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get pods
NAME           READY   STATUS              RESTARTS   AGE
sleepy-94mw8   0/1     Completed           0          15s
sleepy-cl8px   0/1     Completed           0          29s
sleepy-pffgc   0/1     Completed           0          22s
sleepy-r8qpw   0/1     ContainerCreating   0          1s
sleepy-wf2xt   0/1     Completed           0          8s

<span class="c"># 생성한 job 오브젝트 삭제</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete jobs.batch sleepy
job.batch <span class="s2">"sleepy"</span> deleted

<span class="c"># ------------------------------------------------</span>
<span class="c"># parallelism 파라메터(병렬처리) 설정 해보기</span>
<span class="c"># ------------------------------------------------</span>
<span class="c"># parallelism 파라메터 추가</span>
ps0107@k8smaster1:~<span class="nv">$ </span>vi job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: sleepy
spec: <span class="c"># -&gt; pod 2개로 5회 완성이란 의미</span>
  completions: 5
  parallelism: 2 <span class="c"># -&gt; 병렬 처리</span>
  template:
    spec:
      containers:
      - name: resting
        image: busybox
        <span class="nb">command</span>: <span class="o">[</span><span class="s2">"/bin/sleep"</span><span class="o">]</span>
        args: <span class="o">[</span><span class="s2">"3"</span><span class="o">]</span>
      restartPolicy: Never

<span class="c"># job 오브젝트 생성</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl create <span class="nt">-f</span> job.yaml
job.batch/sleepy created

<span class="c"># pod 상태 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get pods
NAME           READY   STATUS              RESTARTS   AGE
sleepy-2v8jd   0/1     ContainerCreating   0          6s
sleepy-xbj79   1/1     Running             0          6s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get pods
NAME           READY   STATUS              RESTARTS   AGE
sleepy-2v8jd   0/1     Completed           0          13s
sleepy-t4kgz   0/1     ContainerCreating   0          2s
sleepy-tl4rv   1/1     Running             0          5s
sleepy-xbj79   0/1     Completed           0          13s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get pods
NAME           READY   STATUS              RESTARTS   AGE
sleepy-2v8jd   0/1     Completed           0          17s
sleepy-g87m4   0/1     ContainerCreating   0          2s
sleepy-t4kgz   1/1     Running             0          6s
sleepy-tl4rv   0/1     Completed           0          9s
sleepy-xbj79   0/1     Completed           0          17s

<span class="c"># job 오브젝트 삭제</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete jobs.batch sleepy
job.batch <span class="s2">"sleepy"</span> deleted

<span class="c"># ------------------------------------------------</span>
<span class="c"># activeDeadlineSeconds 설정 해보기</span>
<span class="c"># ------------------------------------------------</span>
<span class="c"># duration 지정, 15초안에 complete 안되면 uncomplete 됨. (참고로 이시간은 pod 생성 시간까지 포함됨)</span>
ps0107@k8smaster1:~<span class="nv">$ </span>vi job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: sleepy
spec:
  completions: 5
  parallelism: 2
  activeDeadlineSeconds: 15 <span class="c"># -&gt; duration 지정. 15초 안에 complete안되면 uncomplete됨. pod생성 시간 포함.</span>
  template:
    spec:
      containers:
      - name: resting
        image: busybox
        <span class="nb">command</span>: <span class="o">[</span><span class="s2">"/bin/sleep"</span><span class="o">]</span>
        args: <span class="o">[</span><span class="s2">"5"</span><span class="o">]</span> 
      restartPolicy: Never

<span class="c"># job 오브젝트 생성</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl create <span class="nt">-f</span> job.yaml
job.batch/sleepy created

<span class="c"># pod 상태 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get pods
NAME           READY   STATUS              RESTARTS   AGE
sleepy-rfd4q   0/1     ContainerCreating   0          5s
sleepy-rtrk7   1/1     Running             0          5s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get pods
NAME           READY   STATUS    RESTARTS   AGE
sleepy-rfd4q   1/1     Running   0          8s
sleepy-rtrk7   1/1     Running   0          8s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get pods
NAME           READY   STATUS              RESTARTS   AGE
sleepy-cqv8t   0/1     ContainerCreating   0          0s
sleepy-rfd4q   1/1     Running             0          10s
sleepy-rtrk7   0/1     Completed           0          10s

<span class="c"># job 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get <span class="nb">jobs
</span>NAME     COMPLETIONS   DURATION   AGE
sleepy   2/5           20s        20s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get <span class="nb">jobs
</span>NAME     COMPLETIONS   DURATION   AGE
sleepy   2/5           24s        24s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get <span class="nb">jobs
</span>NAME     COMPLETIONS   DURATION   AGE
sleepy   2/5           82s        82s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get job sleepy <span class="nt">-o</span> yaml
......
status:
  conditions:
  - lastProbeTime: <span class="s2">"2020-02-02T14:15:25Z"</span>
    lastTransitionTime: <span class="s2">"2020-02-02T14:15:25Z"</span>
    message: Job was active longer than specified deadline
    reason: DeadlineExceeded
    status: <span class="s2">"True"</span>
    <span class="nb">type</span>: Failed
  failed: 2
  startTime: <span class="s2">"2020-02-02T14:15:10Z"</span>
  succeeded: 2

<span class="c"># job 오브젝트 삭제</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete jobs.batch sleepy
job.batch <span class="s2">"sleepy"</span> deleted
</pre></table></code></div></div><hr /><h2 id="cronjob-사용">CronJob 사용</h2><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
</pre><td class="rouge-code"><pre><span class="c"># ---------------------------------</span>
<span class="c"># cronjob 기본</span>
<span class="c"># ---------------------------------</span>
ps0107@k8smaster1:~<span class="nv">$ </span>vi cronjob.yaml
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: sleepy
spec:
  schedule: <span class="s2">"*/2 * * * *"</span>
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: resting
            image: busybox
            <span class="nb">command</span>: <span class="o">[</span><span class="s2">"/bin/sleep"</span><span class="o">]</span>
            args: <span class="o">[</span><span class="s2">"5"</span><span class="o">]</span>
          restartPolicy: Never

<span class="c"># cronjob 객체 생성          </span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl create <span class="nt">-f</span> cronjob.yaml
cronjob.batch/sleepy created

<span class="c"># cronjob 상태 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get cronjobs.batch
NAME     SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
sleepy   <span class="k">*</span>/2 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span>   False     0        &lt;none&gt;          11s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get jobs.batch
No resources found.

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get cronjobs.batch
NAME     SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
sleepy   <span class="k">*</span>/2 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span>   False     0        31s             2m25s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get jobs.batch
NAME                COMPLETIONS   DURATION   AGE
sleepy-1580655480   1/1           10s        28s

<span class="c"># 2분 후 새로운 job 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get jobs.batch
NAME                COMPLETIONS   DURATION   AGE
sleepy-1580655480   1/1           10s        2m6s
sleepy-1580655600   0/1           5s         5s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete cronjobs.batch sleepy
cronjob.batch <span class="s2">"sleepy"</span> deleted



<span class="c"># ---------------------------------</span>
<span class="c"># cronjob activeDeadlineSeconds 파라메터 추가</span>
<span class="c"># ---------------------------------</span>
ps0107@k8smaster1:~<span class="nv">$ </span>vi cronjob.yaml
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: sleepy
spec:
  schedule: <span class="s2">"*/2 * * * *"</span>
  jobTemplate:
    spec:
      template:
        spec:
          activeDeadlineSeconds: 10 <span class="c"># -&gt; 10초 지나면 강제 종료</span>
          containers:
          - name: resting
            image: busybox
            <span class="nb">command</span>: <span class="o">[</span><span class="s2">"/bin/sleep"</span><span class="o">]</span>
            args: <span class="o">[</span><span class="s2">"5"</span><span class="o">]</span>
          restartPolicy: Never

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl create <span class="nt">-f</span> cronjob.yaml
cronjob.batch/sleepy created

<span class="c"># 생성후 처음엔 job이 없음.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get <span class="nb">jobs
</span>No resources found.

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get cronjobs.batch
NAME     SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
sleepy   <span class="k">*</span>/2 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span>   False     1        8s              30s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get <span class="nb">jobs
</span>NAME                COMPLETIONS   DURATION   AGE
sleepy-1580655720   1/1           9s         9s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get cronjobs.batch
NAME     SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
sleepy   <span class="k">*</span>/2 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span>   False     0        36s             58s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get <span class="nb">jobs
</span>NAME                COMPLETIONS   DURATION   AGE
sleepy-1580655720   1/1           9s         38s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get cronjobs.batch
NAME     SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
sleepy   <span class="k">*</span>/2 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span>   False     0        47s             69s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get <span class="nb">jobs
</span>NAME                COMPLETIONS   DURATION   AGE
sleepy-1580655720   1/1           9s         2m6s
sleepy-1580655840   0/1           6s         6s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get cronjobs.batch
NAME     SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
sleepy   <span class="k">*</span>/2 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span>   False     1        14s             2m36s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get <span class="nb">jobs
</span>NAME                COMPLETIONS   DURATION   AGE
sleepy-1580655720   1/1           9s         2m15s
sleepy-1580655840   0/1           15s        15s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get cronjobs.batch
NAME     SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
sleepy   <span class="k">*</span>/2 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span>   False     1        25s             2m47s

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get cronjobs.batch
NAME     SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
sleepy   <span class="k">*</span>/2 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span>   False     1        6s              4m28s

<span class="c"># 오브젝트 삭제</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete cronjobs.batch sleepy
cronjob.batch <span class="s2">"sleepy"</span> deleted
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kubernetes/'>Kubernetes</a>, <a href='/categories/kubernetes-administration-course/'>Kubernetes Administration Course</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >kubernetes</a> <a href="/tags/cka/" class="post-tag no-text-decoration" >cka</a> <a href="/tags/lfs458/" class="post-tag no-text-decoration" >LFS458</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[kubernetes-실습] API 객체 - ps's Blog&url=https://ps2046.github.io/posts/09.kubernetes_API/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[kubernetes-실습] API 객체 - ps's Blog&u=https://ps2046.github.io/posts/09.kubernetes_API/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=[kubernetes-실습] API 객체 - ps's Blog&url=https://ps2046.github.io/posts/09.kubernetes_API/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/blog-comments-utterances/">[blog] github blog comments (utterances)</a><li><a href="/posts/17.kubernetes_Scheduling_2/">[kubernetes-실습] Scheduling - Taint를 이용한 pod 배포 관리</a><li><a href="/posts/18.kubernetes_logging_trubleshooting_1/">[kubernetes-실습] 로깅과 트러블슈팅 : 로그위치와 로그 출력 보기</a><li><a href="/posts/19.kubernetes_logging_trubleshooting_2/">[kubernetes-실습] 로깅과 트러블슈팅 : Metrics와 DashBoard</a><li><a href="/posts/20.kubernetes_crd/">[kubernetes-실습] CRD (Custom Resource Definition)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cka/">cka</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/lfs458/">LFS458</a> <a class="post-tag" href="/tags/bash/">bash</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/comments/">comments</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/monitoring/">monitoring</a> <a class="post-tag" href="/tags/system/">system</a> <a class="post-tag" href="/tags/utterances/">utterances</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/17.kubernetes_Scheduling_2/"><div class="card-body"> <span class="timeago small" >Jan 26<i class="unloaded">2021-01-26T08:30:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[kubernetes-실습] Scheduling - Taint를 이용한 pod 배포 관리</h3><div class="text-muted small"><p> Using Taints to Control Pod Deployment taints를 사용하여 어느곳에 pod가 배치되거나 실행을 허용하도록 관리할수 있다. 노드 그룹에 pod들을 할당하여 추가할때 노드 사용을 제한하거나 pod들을 완전히 대피시킬수 있다. 참고 마스터노드가 처음에 NoSchedule taint로 설정되어 있었던것을 기억할 것이다...</p></div></div></a></div><div class="card"> <a href="/posts/18.kubernetes_logging_trubleshooting_1/"><div class="card-body"> <span class="timeago small" >Jan 26<i class="unloaded">2021-01-26T09:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[kubernetes-실습] 로깅과 트러블슈팅 : 로그위치와 로그 출력 보기</h3><div class="text-muted small"><p> 로그 파일들의 위치 알아보기 다양한 로그 파일과 명령 출력 이외에도 journalctl을 사용하여 노드 관점에서 로그를 볼 수 있다. 우리는 로그 파일의 공통적인 위치를 보고, 컨테이너 로그를 보는 명령을 볼 것이다. 다른 컨테이너의 로그를 pod에 적재하는데 전용으로 사용되는 sidecar container의 사용과 같은 다른 로깅 ...</p></div></div></a></div><div class="card"> <a href="/posts/19.kubernetes_logging_trubleshooting_2/"><div class="card-body"> <span class="timeago small" >Jan 26<i class="unloaded">2021-01-26T10:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[kubernetes-실습] 로깅과 트러블슈팅 : Metrics와 DashBoard</h3><div class="text-muted small"><p> Metrics 설정 heapster가 deprecation 되면서 Metrics Server 와 통합되어 개발되고 배포되어지고 있다. 그리고 CNCF의 프로젝트중 프로메테우스도 잘 사용되어지고 있다. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 3...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/08.kubernetes_API_AND_ACCESS/" class="btn btn-outline-primary" prompt="Older"><p>[kubernetes-실습] API AND ACCESS</p></a> <a href="/posts/10.Managing_State_with_Deployments/" class="btn btn-outline-primary" prompt="Newer"><p>[kubernetes-실습] Managing State with Deployments</p></a></div><script src="https://utteranc.es/client.js" repo="ps2046/ps2046-github-io-comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async> </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://ps2046.github.io">ps.jang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/cka/">cka</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/lfs458/">LFS458</a> <a class="post-tag" href="/tags/bash/">bash</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/comments/">comments</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/monitoring/">monitoring</a> <a class="post-tag" href="/tags/system/">system</a> <a class="post-tag" href="/tags/utterances/">utterances</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ps2046.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-158837927-2"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-158837927-2'); }); </script>
