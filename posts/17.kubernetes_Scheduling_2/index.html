<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="[kubernetes-실습] Scheduling - Taint를 이용한 pod 배포 관리" /><meta property="og:locale" content="en" /><meta name="description" content="kubernetes 인증 시험(CKA)에 대비하기 위해 실습을 해보도록 한다." /><meta property="og:description" content="kubernetes 인증 시험(CKA)에 대비하기 위해 실습을 해보도록 한다." /><link rel="canonical" href="https://ps2046.github.io/posts/17.kubernetes_Scheduling_2/" /><meta property="og:url" content="https://ps2046.github.io/posts/17.kubernetes_Scheduling_2/" /><meta property="og:site_name" content="ps’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-26T08:30:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[kubernetes-실습] Scheduling - Taint를 이용한 pod 배포 관리" /><meta name="twitter:site" content="@ps2046" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"kubernetes 인증 시험(CKA)에 대비하기 위해 실습을 해보도록 한다.","headline":"[kubernetes-실습] Scheduling - Taint를 이용한 pod 배포 관리","dateModified":"2021-08-26T00:00:00+09:00","url":"https://ps2046.github.io/posts/17.kubernetes_Scheduling_2/","datePublished":"2021-01-26T08:30:00+09:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ps2046.github.io/posts/17.kubernetes_Scheduling_2/"},"@context":"https://schema.org"}</script><title>[kubernetes-실습] Scheduling - Taint를 이용한 pod 배포 관리 | ps's Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ps's Blog"><meta name="application-name" content="ps's Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7635228999568716" crossorigin="anonymous"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/11029548?s=400&u=5ebc191faa53e931968ec2ed98bd7c7b68136c71&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ps's Blog</a></div><div class="site-subtitle font-italic">System Engineer & Developer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ps2046" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/ps2046" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ps2046.jang','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[kubernetes-실습] Scheduling - Taint를 이용한 pod 배포 관리</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>[kubernetes-실습] Scheduling - Taint를 이용한 pod 배포 관리</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> ps.jang </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Jan 26, 2021, 8:30 AM +0900" >Jan 26<i class="unloaded">2021-01-26T08:30:00+09:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Aug 26, 2021, 12:00 AM +0000" >Aug 26<i class="unloaded">2021-08-26T00:00:00+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2022 words">11 min read</span></div></div><div class="post-content"><h2 id="using-taints-to-control-pod-deployment">Using Taints to Control Pod Deployment</h2><ul><li>taints를 사용하여 어느곳에 pod가 배치되거나 실행을 허용하도록 관리할수 있다. 노드 그룹에 pod들을 할당하여 추가할때 노드 사용을 제한하거나 pod들을 완전히 대피시킬수 있다. 참고 마스터노드가 처음에 NoSchedule taint로 설정되어 있었던것을 기억할 것이다. 여기서 taint의 3가지 유형을 통해 pod들을 제한하거나 제거하는것을 알아보자.</ul><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="c"># 8개의 nginx container를 배포하는 deployment를 생성하기 위해 yaml파일을 생성해보자.</span>
ps0107@k8smaster1:~<span class="nv">$ </span><span class="nb">cat </span>taint.yaml
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: taint-deployment
spec:
  replicas: 8
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name:  nginx
        image: nginx:1.11.1
        ports:
        - containerPort: 80

<span class="c"># deployment를 생성한다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> taint.yaml
deployment.apps/taint-deployment created

<span class="c"># 생성된 container 를 확인해보자</span>
ps0107@k8smaster1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx
c30666cbe396        0d409d33b27e           <span class="s2">"nginx -g 'daemon of…"</span>   15 seconds ago      Up 15 seconds                           k8s_nginx_taint-deployment-5798dd968b-s65vc_default_3a1c1e9e-fb9e-4a9e-b3e5-f95b83d3dfbf_0                                                a609a64cb268        0d409d33b27e           <span class="s2">"nginx -g 'daemon of…"</span>   15 seconds ago      Up 15 seconds                           k8s_nginx_taint-deployment-5798dd968b-9q66n_default_5995ab88-5a65-4828-975a-9a3fe63ceda8_0                                                f71768c1813b        0d409d33b27e           <span class="s2">"nginx -g 'daemon of…"</span>   16 seconds ago      Up 15 seconds                           k8s_nginx_taint-deployment-5798dd968b-4nq2l_default_fbe7348a-ec4d-4f8c-b5d3-41f4d52ce370_0

<span class="c"># container 갯수를 비교해본다.</span>
<span class="c"># 현재 기준으로 master 3개, worker 5개 가 생성되었다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx | <span class="nb">wc</span> <span class="nt">-l</span>
3

ps0107@k8sworker1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx | <span class="nb">wc</span> <span class="nt">-l</span>
5

<span class="c"># deployment 삭제 후 container 갯수를 다시 확인해본다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete deployment taint-deployment
deployment.extensions <span class="s2">"taint-deployment"</span> deleted

ps0107@k8smaster1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx | <span class="nb">wc</span> <span class="nt">-l</span>
0

ps0107@k8sworker1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx | <span class="nb">wc</span> <span class="nt">-l</span>
0
</pre></table></code></div></div><ul><li>이제 우리는 새 컨테이너의 배치에 영향을 미치는 taint를 사용할 것이다. taint 에는 NoSchedule, PreferNoSchedule, NoExecute 이렇게 3가지 유형이 있다. schedule과 관련된 taint는 새로 배치된 컨테이너를 결정하기 위해 사용될 것이지만, 실행 중인 컨테이너에는 영향을 미치지 않는다. “NoExecute”를 사용하면 실행 중인 컨테이너가 움직이게 된다.</ul><hr /><h2 id="prefernoschedule-로-taint-설정">PreferNoSchedule 로 Taint 설정</h2><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="c"># ----------------</span>
<span class="c"># PreferNoSchedule 로 Taint 설정</span>
<span class="c"># ----------------</span>
<span class="c"># secondary node에 Taint를 걸고 확인한 다음 다시 deployment를 생성해본다. 그런 다음 pod들을 추적해 보도록 한다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl taint nodes k8sworker1 <span class="nv">bubba</span><span class="o">=</span>value:PreferNoSchedule
node/k8sworker1 tainted

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe node | <span class="nb">grep </span>Taint
Taints:             &lt;none&gt;
Taints:             <span class="nv">bubba</span><span class="o">=</span>value:PreferNoSchedule

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> taint.yaml 
deployment.apps/taint-deployment created

<span class="c"># 컨테이너가 어디에서 running 중인지 살펴본다. </span>
<span class="c"># 마스터 쪽에 더 많은 컨테이너가 있다는 것을 알 수 있다. 하지만 여전히 worker 노드에도 몇몇의 컨테이너가 만들어 졌다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx | <span class="nb">wc</span> <span class="nt">-l</span>
5

ps0107@k8sworker1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx | <span class="nb">wc</span> <span class="nt">-l</span>
3

<span class="c"># deployment를 삭제한다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete deployments taint-deployment
deployment.extensions <span class="s2">"taint-deployment"</span> deleted

<span class="c"># taint 삭제</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl taint node k8sworker1 bubba-
node/k8sworker1 untainted

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe nodes | <span class="nb">grep </span>Taint
Taints:             &lt;none&gt;
Taints:             &lt;none&gt;
</pre></table></code></div></div><hr /><h2 id="noschedule-로-taint-설정">NoSchedule 로 Taint 설정</h2><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="c"># ----------------</span>
<span class="c"># NoSchedule 로 Taint 설정</span>
<span class="c"># ----------------</span>
<span class="c"># 이번엔 NoSchedule로 Taint를 설정하고 다시 deployment를 생성해본다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl taint node k8sworker1 <span class="nv">bubba</span><span class="o">=</span>value:NoSchedule
node/k8sworker1 tainted

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe nodes | <span class="nb">grep </span>Taint
Taints:             &lt;none&gt;
Taints:             <span class="nv">bubba</span><span class="o">=</span>value:NoSchedule

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> taint.yaml 
deployment.apps/taint-deployment created

<span class="c"># secondary node에는 새로운 pod들이 생성되지 않았다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx | <span class="nb">wc</span> <span class="nt">-l</span>
8

ps0107@k8sworker1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx | <span class="nb">wc</span> <span class="nt">-l</span>
0

<span class="c"># deployment 삭제</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete deployment taint-deployment
deployment.extensions <span class="s2">"taint-deployment"</span> deleted

<span class="c"># Taint 설정 삭제</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl taint node k8sworker1 bubba-
node/k8sworker1 untainted
</pre></table></code></div></div><hr /><h2 id="이번엔-taint-설정-없이-생성해보자">이번엔 Taint 설정 없이 생성해보자</h2><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="c"># ----------------</span>
<span class="c"># 이번엔 Taint 설정 없이 생성해보자</span>
<span class="c"># ----------------</span>
<span class="c"># deployment 생성</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> taint.yaml 
deployment.apps/taint-deployment created

<span class="c"># Taint 설정이 없을 경우 schedule 에 따라 pod들이 배포되었다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx | <span class="nb">wc</span> <span class="nt">-l</span>
3

ps0107@k8sworker1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx | <span class="nb">wc</span> <span class="nt">-l</span>
5
</pre></table></code></div></div><hr /><h2 id="noexecute-로-taint-설정">NoExecute 로 Taint 설정</h2><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="c"># ----------------</span>
<span class="c"># NoExecute 로 Taint 설정</span>
<span class="c"># ----------------</span>
<span class="c"># NoExecute로 secondary node에 설정하고, 잠시 후에 container 들이 이동되었는지 확인한다.</span>
<span class="c"># DNS 컨테이너는 종료되는데 시간이 걸릴 수 있고, 몇몇의 컨테이너들은 작업 노드에 남아 클러스터로부터의 통신을 계속 한다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl taint node k8sworker1 <span class="nv">bubba</span><span class="o">=</span>value:NoExecute
node/k8sworker1 tainted

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe nodes | <span class="nb">grep </span>Taint
Taints:             &lt;none&gt;
Taints:             <span class="nv">bubba</span><span class="o">=</span>value:NoExecute

<span class="c"># 마스터 노드에 기존 3개에서 현재 5개가 worker node에서 이동되어 8개가 되었다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx | <span class="nb">wc</span> <span class="nt">-l</span>
8

ps0107@k8sworker1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx | <span class="nb">wc</span> <span class="nt">-l</span>
0

<span class="c"># Taint 제거 후 잠시 후에 pod들을 확인 해보면 이전 위치로 다시 돌아가지않는 것을 확인할 수 있다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl taint node k8sworker1 bubba-
node/k8sworker1 untainted

<span class="c"># Taint 제거후에도 같은 상태로 유지되고 있다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx | <span class="nb">wc</span> <span class="nt">-l</span>
8

ps0107@k8sworker1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx | <span class="nb">wc</span> <span class="nt">-l</span>
0
</pre></table></code></div></div><hr /><h2 id="drain-에-대해-간단하게-알아보자">drain 에 대해 간단하게 알아보자</h2><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
</pre><td class="rouge-code"><pre><span class="c"># ---------------------------------------------</span>
<span class="c"># drain 에 대해 간단하게 알아보자</span>
<span class="c"># ---------------------------------------------</span>
<span class="c"># 노드에 taint를 적용하는거 외에 "drain" 상태로 설정할 수 있다. </span>
<span class="c"># 먼저 status를 확인한 다음 존재하는 deployment를 삭제한다.</span>
<span class="c"># 컨테이너의 실행을 허용하지 않더라도 상태는 "Ready"로 보여진다.</span>
<span class="c"># 이전 실습에서 봤던거 처럼, DaemonSet으로 관리되는 pod는 기본적으로 영향을 받지 않는다.</span>
<span class="c"># 이번에는 기존의 pod와 node에 어떤 일들이 일어나는지 자세히 확인해 보자.</span>

<span class="c"># 현재 node의 STATUS를 확인해보자. 둘다 Ready 상태로 보여진다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get nodes 
NAME         STATUS   ROLES    AGE     VERSION
k8smaster1   Ready    master   7d17h   v1.15.1
k8sworker1   Ready    &lt;none&gt;   7d17h   v1.15.1

<span class="c"># drain 명령을 사용</span>
<span class="c"># drain 을 통해 해당 노드에 cordon이 되어지고, daemonSet pod 나 volume 등으로 error가 발생할 수 있다.</span>
<span class="c"># 이때 로그대로 옵션등을 통해 해결할 수 있다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl drain k8sworker1
node/k8sworker1 cordoned  <span class="c"># &lt;-- 현재 노드에 cordon은 되었고, drain 과정중 daemonSet pod들로 인해 error 가 발생하였다.  </span>
error: unable to drain node <span class="s2">"k8sworker1"</span>, aborting command...

There are pending nodes to be drained:
 k8sworker1
error: cannot delete DaemonSet-managed Pods <span class="o">(</span>use <span class="nt">--ignore-daemonsets</span> to ignore<span class="o">)</span>: kube-system/calico-node-zxkxk, kube-system/kube-proxy-tnmtr, kube-system/traefik-ingress-controller-8884w

<span class="c"># worker 노드 상태를 보면 Ready 상태이지만 새로운 pod들을 schedule 하지 않도록 설정되어 있다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get nodes 
NAME         STATUS                     ROLES    AGE     VERSION
k8smaster1   Ready                      master   7d17h   v1.15.1
k8sworker1   Ready,SchedulingDisabled   &lt;none&gt;   7d17h   v1.15.1

<span class="c"># deployment를 삭제후 다시 생성해 보자</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete deployments taint-deployment
deployment.extensions <span class="s2">"taint-deployment"</span> deleted

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> taint.yaml 
deployment.apps/taint-deployment created

<span class="c"># 예상대로 새로운 pod들이 worker node쪽으로 schedule 되지 않고 master 쪽으로 schedule 되었다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx | <span class="nb">wc</span> <span class="nt">-l</span>
8

ps0107@k8sworker1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx | <span class="nb">wc</span> <span class="nt">-l</span>
0

<span class="c"># worker node를 다시 사용할수 있도록 uncordon 해준다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl uncordon k8sworker1
node/k8sworker1 uncordoned

<span class="c"># node 상태를 확인해본다. 상태가 다시 Ready상태로 바뀌었다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl  get nodes 
NAME         STATUS   ROLES    AGE     VERSION
k8smaster1   Ready    master   7d17h   v1.15.1
k8sworker1   Ready    &lt;none&gt;   7d17h   v1.15.1

<span class="c"># deployment를 삭제하고 재생성하여 두개의 노드로 분산되어 schedule 되는지 확인 해본다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete deployment taint-deployment
deployment.extensions <span class="s2">"taint-deployment"</span> deleted

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl apply <span class="nt">-f</span> taint.yaml 
deployment.apps/taint-deployment created

ps0107@k8smaster1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx | <span class="nb">wc</span> <span class="nt">-l</span>
2

ps0107@k8sworker1:~<span class="nv">$ </span><span class="nb">sudo </span>docker ps | <span class="nb">grep </span>nginx | <span class="nb">wc</span> <span class="nt">-l</span>
6

<span class="c"># 테스트 후 리소스를 정리한다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete deployment taint-deployment
deployment.extensions <span class="s2">"taint-deployment"</span> deleted
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kubernetes/'>Kubernetes</a>, <a href='/categories/kubernetes-administration-course/'>Kubernetes Administration Course</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >kubernetes</a> <a href="/tags/cka/" class="post-tag no-text-decoration" >cka</a> <a href="/tags/lfs458/" class="post-tag no-text-decoration" >LFS458</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[kubernetes-실습] Scheduling - Taint를 이용한 pod 배포 관리 - ps's Blog&url=https://ps2046.github.io/posts/17.kubernetes_Scheduling_2/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[kubernetes-실습] Scheduling - Taint를 이용한 pod 배포 관리 - ps's Blog&u=https://ps2046.github.io/posts/17.kubernetes_Scheduling_2/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=[kubernetes-실습] Scheduling - Taint를 이용한 pod 배포 관리 - ps's Blog&url=https://ps2046.github.io/posts/17.kubernetes_Scheduling_2/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/blog-comments-utterances/">[blog] github blog comments (utterances)</a><li><a href="/posts/17.kubernetes_Scheduling_2/">[kubernetes-실습] Scheduling - Taint를 이용한 pod 배포 관리</a><li><a href="/posts/18.kubernetes_logging_trubleshooting_1/">[kubernetes-실습] 로깅과 트러블슈팅 : 로그위치와 로그 출력 보기</a><li><a href="/posts/19.kubernetes_logging_trubleshooting_2/">[kubernetes-실습] 로깅과 트러블슈팅 : Metrics와 DashBoard</a><li><a href="/posts/20.kubernetes_crd/">[kubernetes-실습] CRD (Custom Resource Definition)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cka/">cka</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/lfs458/">LFS458</a> <a class="post-tag" href="/tags/bash/">bash</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/comments/">comments</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/monitoring/">monitoring</a> <a class="post-tag" href="/tags/system/">system</a> <a class="post-tag" href="/tags/utterances/">utterances</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/18.kubernetes_logging_trubleshooting_1/"><div class="card-body"> <span class="timeago small" >Jan 26<i class="unloaded">2021-01-26T09:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[kubernetes-실습] 로깅과 트러블슈팅 : 로그위치와 로그 출력 보기</h3><div class="text-muted small"><p> 로그 파일들의 위치 알아보기 다양한 로그 파일과 명령 출력 이외에도 journalctl을 사용하여 노드 관점에서 로그를 볼 수 있다. 우리는 로그 파일의 공통적인 위치를 보고, 컨테이너 로그를 보는 명령을 볼 것이다. 다른 컨테이너의 로그를 pod에 적재하는데 전용으로 사용되는 sidecar container의 사용과 같은 다른 로깅 ...</p></div></div></a></div><div class="card"> <a href="/posts/19.kubernetes_logging_trubleshooting_2/"><div class="card-body"> <span class="timeago small" >Jan 26<i class="unloaded">2021-01-26T10:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[kubernetes-실습] 로깅과 트러블슈팅 : Metrics와 DashBoard</h3><div class="text-muted small"><p> Metrics 설정 heapster가 deprecation 되면서 Metrics Server 와 통합되어 개발되고 배포되어지고 있다. 그리고 CNCF의 프로젝트중 프로메테우스도 잘 사용되어지고 있다. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 3...</p></div></div></a></div><div class="card"> <a href="/posts/20.kubernetes_crd/"><div class="card-body"> <span class="timeago small" >Jan 26<i class="unloaded">2021-01-26T11:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[kubernetes-실습] CRD (Custom Resource Definition)</h3><div class="text-muted small"><p> Custom Resource Definition 생성 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 5...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/16.kubernetes_Scheduling_1/" class="btn btn-outline-primary" prompt="Older"><p>[kubernetes-실습] Scheduling - label 사용한 pod 할당</p></a> <a href="/posts/18.kubernetes_logging_trubleshooting_1/" class="btn btn-outline-primary" prompt="Newer"><p>[kubernetes-실습] 로깅과 트러블슈팅 : 로그위치와 로그 출력 보기</p></a></div><script src="https://utteranc.es/client.js" repo="ps2046/ps2046-github-io-comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async> </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://ps2046.github.io">ps.jang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/cka/">cka</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/lfs458/">LFS458</a> <a class="post-tag" href="/tags/bash/">bash</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/comments/">comments</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/monitoring/">monitoring</a> <a class="post-tag" href="/tags/system/">system</a> <a class="post-tag" href="/tags/utterances/">utterances</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ps2046.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-158837927-2"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-158837927-2'); }); </script>
