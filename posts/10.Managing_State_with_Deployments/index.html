<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="[kubernetes-실습] Managing State with Deployments" /><meta property="og:locale" content="en" /><meta name="description" content="kubernetes 인증 시험(CKA)에 대비하기 위해 실습을 해보도록 한다." /><meta property="og:description" content="kubernetes 인증 시험(CKA)에 대비하기 위해 실습을 해보도록 한다." /><link rel="canonical" href="https://ps2046.github.io/posts/10.Managing_State_with_Deployments/" /><meta property="og:url" content="https://ps2046.github.io/posts/10.Managing_State_with_Deployments/" /><meta property="og:site_name" content="ps’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-01-26T05:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="[kubernetes-실습] Managing State with Deployments" /><meta name="twitter:site" content="@ps2046" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"description":"kubernetes 인증 시험(CKA)에 대비하기 위해 실습을 해보도록 한다.","headline":"[kubernetes-실습] Managing State with Deployments","dateModified":"2021-08-26T00:00:00+09:00","url":"https://ps2046.github.io/posts/10.Managing_State_with_Deployments/","datePublished":"2021-01-26T05:00:00+09:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://ps2046.github.io/posts/10.Managing_State_with_Deployments/"},"@context":"https://schema.org"}</script><title>[kubernetes-실습] Managing State with Deployments | ps's Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ps's Blog"><meta name="application-name" content="ps's Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7635228999568716" crossorigin="anonymous"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/11029548?s=400&u=5ebc191faa53e931968ec2ed98bd7c7b68136c71&v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ps's Blog</a></div><div class="site-subtitle font-italic">System Engineer & Developer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/ps2046" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/ps2046" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['ps2046.jang','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>[kubernetes-실습] Managing State with Deployments</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>[kubernetes-실습] Managing State with Deployments</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> ps.jang </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, Jan 26, 2021, 5:00 AM +0900" >Jan 26<i class="unloaded">2021-01-26T05:00:00+09:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Aug 26, 2021, 12:00 AM +0000" >Aug 26<i class="unloaded">2021-08-26T00:00:00+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2312 words">12 min read</span></div></div><div class="post-content"><h2 id="replicaset-동작">ReplicaSet 동작</h2><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
</pre><td class="rouge-code"><pre><span class="c"># ReplicaSet 생성을 위한 yaml 파일 생성</span>
ps0107@k8smaster1:~<span class="nv">$ </span>vi rs.yaml
apiVersion: extensions/v1beta1
kind: ReplicaSet
metadata:
  name: rs-one
spec:
  replicas: 2
  template:
    metadata:
      labels:
        system: ReplicaOne
    spec:
      containers:
      - name: nginx
        image: nginx:1.11.1
        ports:
        - containerPort: 80
 
<span class="c"># ReplicaSet 생성</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl create <span class="nt">-f</span> rs.yaml 
replicaset.extensions/rs-one created

<span class="c"># 생성된 ReplicaSet 상세 내용 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe rs rs-one 
Name:         rs-one
Namespace:    default
Selector:     <span class="nv">system</span><span class="o">=</span>ReplicaOne
Labels:       <span class="nv">system</span><span class="o">=</span>ReplicaOne
Annotations:  &lt;none&gt;
Replicas:     2 current / 2 desired
Pods Status:  0 Running / 2 Waiting / 0 Succeeded / 0 Failed
Pod Template:
  Labels:  <span class="nv">system</span><span class="o">=</span>ReplicaOne
  Containers:
   nginx:
    Image:        nginx:1.11.1
    Port:         80/TCP
    Host Port:    0/TCP
    Environment:  &lt;none&gt;
    Mounts:       &lt;none&gt;
  Volumes:        &lt;none&gt;
Events:
  Type    Reason            Age   From                   Message
  <span class="nt">----</span>    <span class="nt">------</span>            <span class="nt">----</span>  <span class="nt">----</span>                   <span class="nt">-------</span>
  Normal  SuccessfulCreate  10s   replicaset-controller  Created pod: rs-one-dxxl2
  Normal  SuccessfulCreate  10s   replicaset-controller  Created pod: rs-one-k4nm9

<span class="c"># 생성된 pod 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get pods
NAME           READY   STATUS    RESTARTS   AGE
rs-one-dxxl2   1/1     Running   0          24s
rs-one-k4nm9   1/1     Running   0          24s

<span class="c"># ReplicaSet 객체만 삭제하고 하위에 pod는 그냥 놔둠 (--cascade=false)</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete rs rs-one <span class="nt">--cascade</span><span class="o">=</span><span class="nb">false 
</span>replicaset.extensions <span class="s2">"rs-one"</span> deleted

<span class="c"># ReplicaSet 삭제된거 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe rs rs-one
Error from server <span class="o">(</span>NotFound<span class="o">)</span>: replicasets.extensions <span class="s2">"rs-one"</span> not found

<span class="c"># pod는 남아 있는지 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get pods
NAME           READY   STATUS    RESTARTS   AGE
rs-one-dxxl2   1/1     Running   0          76s
rs-one-k4nm9   1/1     Running   0          76s

<span class="c"># 다시 ReplicaSet을 생성해 본다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl create <span class="nt">-f</span> rs.yaml 
replicaset.extensions/rs-one created

<span class="c"># 생성이 잘되었다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get rs
NAME     DESIRED   CURRENT   READY   AGE
rs-one   2         2         2       6s

<span class="c"># 하지만 pod는 기존에 생성했던 pod 들이다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get pod
NAME           READY   STATUS    RESTARTS   AGE
rs-one-dxxl2   1/1     Running   0          107s
rs-one-k4nm9   1/1     Running   0          107s

<span class="c"># pod 하나의 label을 수정해보자 (system: IsolatedPod 로..)</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl edit po rs-one-dxxl2
pod/rs-one-dxxl2 edited

<span class="c"># ReplicaSet을 조회해 보면 그대로 2개 러닝중이다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get rs
NAME     DESIRED   CURRENT   READY   AGE
rs-one   2         2         2       2m6s

<span class="c"># pod를 system 이라는 label 로 조회해 본다.</span>
<span class="c"># 수정한 거 빼고 새로 하나가 올라온걸 볼수 있다.</span>
<span class="c"># 2개를 유지하려고 하고 있다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get pod <span class="nt">-L</span> system
NAME           READY   STATUS    RESTARTS   AGE     SYSTEM
rs-one-95sch   1/1     Running   0          23s     ReplicaOne
rs-one-dxxl2   1/1     Running   0          3m56s   IsolatedPod
rs-one-k4nm9   1/1     Running   0          3m56s   ReplicaOne

<span class="c"># ReplicaSet을 삭제 한다</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete rs rs-one
replicaset.extensions <span class="s2">"rs-one"</span> deleted

<span class="c"># system 라벨이 IsolatedPod는 그대로 남아 있다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl  get pod
NAME           READY   STATUS    RESTARTS   AGE
rs-one-dxxl2   1/1     Running   0          4m26s

<span class="c"># ReplicaSet은 삭제 되어있다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get rs
No resources found.

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get po
NAME           READY   STATUS    RESTARTS   AGE
rs-one-dxxl2   1/1     Running   0          4m43s

<span class="c">#  system=IsolatedPod 라벨링 되어 있는 pod를 삭제한다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete po <span class="nt">-l</span> <span class="nv">system</span><span class="o">=</span>IsolatedPod
pod <span class="s2">"rs-one-dxxl2"</span> deleted

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get pod
No resources found.
</pre></table></code></div></div><hr /><h2 id="daemonset-동작">DaemonSet 동작</h2><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="c"># DaemonSet 생성을 위한 yaml 파일 생성</span>
ps0107@k8smaster1:~<span class="nv">$ </span><span class="nb">cat </span>ds.yaml 
apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  name: ds-one
spec:
  template:
    metadata:
      labels:
        system: ReplicaOne
    spec:
      containers:
      - name: nginx
        image: nginx:1.11.1
        ports:
        - containerPort: 80
 
<span class="c"># DaemonSet 생성</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl create <span class="nt">-f</span> ds.yaml 
daemonset.extensions/ds-one created

<span class="c"># 각 노드에 한개씩 러닝이라 현재 2개 확인 가능</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get ds
NAME     DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
ds-one   2         2         2       2            2           &lt;none&gt;          4s

<span class="c"># 생성된 pod가 각 노드에 한개씩 러닝중이다. </span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> wide
NAME           READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES
ds-one-6sjkv   1/1     Running   0          13s   192.168.0.29   k8smaster1   &lt;none&gt;           &lt;none&gt;
ds-one-hpx96   1/1     Running   0          13s   192.168.1.70   k8sworker1   &lt;none&gt;           &lt;none&gt;

<span class="c"># 현재 러닝중인 nginx의 이미지 버전확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe po ds-one-6sjkv | <span class="nb">grep</span> <span class="s2">"Image:"</span>
    Image:          nginx:1.11.1
</pre></table></code></div></div><hr /><h2 id="rolling-updates-and-rollback">Rolling Updates And Rollback</h2><div lang="bash" class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
</pre><td class="rouge-code"><pre><span class="c"># ---------------------------------------------------------------</span>
<span class="c"># updateStrategy의 설정을 OnDelete 로 했을때 테스트</span>
<span class="c"># ---------------------------------------------------------------</span>
<span class="c"># 현재 updateStrategy 설정 확인 </span>
<span class="c"># OnDelete : 이미지를 변경하더라도 이전 버전을 수동 삭제해야 새로운 버전으로 생성됨.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get ds ds-one <span class="nt">-o</span> yaml | <span class="nb">grep</span> <span class="nt">-A</span> 1 Strategy
updateStrategy:
        <span class="nb">type</span>: OnDelete

<span class="c"># daemonSet의 nginx이미지 버전을 수정해보자</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl <span class="nb">set </span>image ds ds-one <span class="nv">nginx</span><span class="o">=</span>nginx:1.12.1-alpine
daemonset.extensions/ds-one image updated

<span class="c"># pod들의 이미지 버전을 보면 아직 바뀐상태가 아니다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe po ds-one-6sjkv | <span class="nb">grep</span> <span class="s2">"Image:"</span>
    Image:          nginx:1.11.1    

<span class="c"># 삭제를 해야 바뀐다. 삭제를 해보자.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete po ds-one-6sjkv
pod <span class="s2">"ds-one-6sjkv"</span> deleted

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> wide
NAME           READY   STATUS              RESTARTS   AGE    IP             NODE         NOMINATED NODE   READINESS GATES
ds-one-hpx96   1/1     Running             0          9m4s   192.168.1.70   k8sworker1   &lt;none&gt;           &lt;none&gt;
ds-one-rvrdb   0/1     ContainerCreating   0          6s     &lt;none&gt;         k8smaster1   &lt;none&gt;           &lt;none&gt;

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get pod <span class="nt">-o</span> wide
NAME           READY   STATUS    RESTARTS   AGE     IP             NODE         NOMINATED NODE   READINESS GATES
ds-one-hpx96   1/1     Running   0          9m19s   192.168.1.70   k8sworker1   &lt;none&gt;           &lt;none&gt;
ds-one-rvrdb   1/1     Running   0          21s     192.168.0.30   k8smaster1   &lt;none&gt;           &lt;none&gt;

<span class="c"># 기존 pod 의 이미지버전</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe po ds-one-hpx96 | <span class="nb">grep</span> <span class="s2">"Image:"</span>
    Image:          nginx:1.11.1
 
<span class="c"># 삭제후 새로 생성된 이미지의 버전 이다. (잘 바귄걸로 올라왔다)</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe po ds-one-rvrdb | <span class="nb">grep</span> <span class="s2">"Image:"</span>
    Image:          nginx:1.12.1-alpine
 
<span class="c"># edit로 수정후 history를 확인 할 수도 있다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl rollout <span class="nb">history </span>ds ds-one
daemonset.extensions/ds-one 
REVISION  CHANGE-CAUSE
1         &lt;none&gt;
2         &lt;none&gt;

<span class="c"># revision 1번은 1.11.1 이전 버전</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl rollout <span class="nb">history </span>ds ds-one <span class="nt">--revision</span><span class="o">=</span>1
daemonset.extensions/ds-one with revision <span class="c">#1</span>
Pod Template:
  Labels:system<span class="o">=</span>ReplicaOne
  Containers:
   nginx:
    Image:nginx:1.11.1
    Port:80/TCP
    Host Port:0/TCP
    Environment:&lt;none&gt;
    Mounts:&lt;none&gt;
  Volumes:&lt;none&gt;

<span class="c"># revision 2번은 새로 수정한 버전임을 알수 있다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl rollout <span class="nb">history </span>ds ds-one <span class="nt">--revision</span><span class="o">=</span>2
daemonset.extensions/ds-one with revision <span class="c">#2</span>
Pod Template:
  Labels:system<span class="o">=</span>ReplicaOne
  Containers:
   nginx:
    Image:nginx:1.12.1-alpine
    Port:80/TCP
    Host Port:0/TCP
    Environment:&lt;none&gt;
    Mounts:&lt;none&gt;
  Volumes:&lt;none&gt;

<span class="c"># 이전 버전인 1.11.1버전으로 rollout undo를 실행하여 본다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl rollout undo ds ds-one <span class="nt">--to-revision</span><span class="o">=</span>1
daemonset.extensions/ds-one rolled back

<span class="c"># 그런데 바로 바뀌지 않는다...</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe po ds-one-rvrdb | <span class="nb">grep</span> <span class="s2">"Image:"</span>
Image:          nginx:1.12.1-alpine

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe po ds-one-hpx96 | <span class="nb">grep</span> <span class="s2">"Image:"</span>
    Image:          nginx:1.11.1  

<span class="c"># 바로 위에서 본 updateStrategy 설정 때문에 pod를 삭제 해야 다시 뜨면서 적용된다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete po ds-one-rvrdb
pod <span class="s2">"ds-one-rvrdb"</span> deleted

<span class="c"># 삭제 후 새로 생성된 pod를 확인할 수 있다</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get po
NAME           READY   STATUS    RESTARTS   AGE
ds-one-65r2h   1/1     Running   0          4s
ds-one-hpx96   1/1     Running   0          12m

<span class="c"># 새로 생성된 pod의 이미지 버전을 확인해본다. 정상적으로 undo 되어 올라왔다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe po ds-one-65r2h | <span class="nb">grep</span> <span class="s2">"Image:"</span>
    Image:          nginx:1.11.1

<span class="c"># 현재 ds-one 객체의 상세 정보를 확인해본다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get ds ds-one <span class="nt">-o</span> yaml
apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  creationTimestamp: <span class="s2">"2020-02-03T03:08:40Z"</span>
  generation: 3
  labels:
    system: ReplicaOne
  name: ds-one
  namespace: default
  resourceVersion: <span class="s2">"670771"</span>
  selfLink: /apis/extensions/v1beta1/namespaces/default/daemonsets/ds-one
  uid: cd8e3a1e-8c9a-4a74-96ea-b0030e5711ae
spec:
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      system: ReplicaOne
  template:
    metadata:
      creationTimestamp: null
      labels:
        system: ReplicaOne
    spec:
      containers:
      - image: nginx:1.11.1
        imagePullPolicy: IfNotPresent
        name: nginx
        ports:
        - containerPort: 80
          protocol: TCP
        resources: <span class="o">{}</span>
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: <span class="o">{}</span>
      terminationGracePeriodSeconds: 30
  templateGeneration: 3
  updateStrategy:
    <span class="nb">type</span>: OnDelete
status:
  currentNumberScheduled: 2
  desiredNumberScheduled: 2
  numberAvailable: 2
  numberMisscheduled: 0
  numberReady: 2
  observedGeneration: 3
  updatedNumberScheduled: 2

<span class="c"># ---------------------------------------------------------------</span>
<span class="c"># updateStrategy의 설정을 RollingUpdate 로 수정후 테스트 해보자</span>
<span class="c"># ---------------------------------------------------------------</span>
<span class="c"># 기존 객체에서 복사해서 name과 updateStrategy 부분을 수정해 보자</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get ds ds-one <span class="nt">-o</span> yaml <span class="nt">--export</span> <span class="o">&gt;</span> ds2.yaml 
Flag <span class="nt">--export</span> has been deprecated, This flag is deprecated and will be removed <span class="k">in </span>future.

ps0107@k8smaster1:~<span class="nv">$ </span>vi ds2.yaml 
apiVersion: extensions/v1beta1
kind: DaemonSet
metadata:
  creationTimestamp: null
  generation: 1
  labels:
    system: ReplicaOne
  name: ds-two
  selfLink: /apis/extensions/v1beta1/namespaces/default/daemonsets/ds-one
spec:
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      system: ReplicaOne
  template:
    metadata:
      creationTimestamp: null
      labels:
        system: ReplicaOne
    spec:
      containers:
      - image: nginx:1.11.1
        imagePullPolicy: IfNotPresent
        name: nginx
        ports:
        - containerPort: 80
          protocol: TCP
        resources: <span class="o">{}</span>
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: <span class="o">{}</span>
      terminationGracePeriodSeconds: 30
  templateGeneration: 3
  updateStrategy:
    <span class="nb">type</span>: RollingUpdate
status:
  currentNumberScheduled: 0
  desiredNumberScheduled: 0
  numberMisscheduled: 0
  numberReady: 0

<span class="c"># 새로운 ds-two객체를 생성해 보자.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl create <span class="nt">-f</span> ds2.yaml 
daemonset.extensions/ds-two created

<span class="c"># 새로 pod가 2개 생성되었다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get po
NAME           READY   STATUS    RESTARTS   AGE
ds-one-65r2h   1/1     Running   0          4m30s
ds-one-hpx96   1/1     Running   0          16m
ds-two-49d8t   1/1     Running   0          6s
ds-two-sgpdh   1/1     Running   0          6s

<span class="c"># 생성된 pod의 이미지 버전을 확인해보자 (1.11.1 이다)</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe po ds-two-49d8t | <span class="nb">grep</span> <span class="s2">"Image:"</span> 
Image:          nginx:1.11.1 

<span class="c"># edit 명령으로 이미지 버전을 수정해 보자 (1.12.1-alpine으로)</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl edit ds ds-two 
daemonset.extensions/ds-two edited

<span class="c"># ds-two의 상태 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get ds ds-two
NAME     DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
ds-two   2         2         1       1            1           &lt;none&gt;          82s

<span class="c"># 생성된 pod를 확인해 본다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl get pod
NAME           READY   STATUS    RESTARTS   AGE
ds-one-65r2h   1/1     Running   0          6m8s
ds-one-hpx96   1/1     Running   0          18m
ds-two-2px2q   1/1     Running   0          19s
ds-two-kpsfx   1/1     Running   0          35s

<span class="c"># 두개의 pod 가 버전이 수정된걸로 다시 생성되었다.</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe po ds-two-2px2q | <span class="nb">grep</span> <span class="s2">"Image:"</span>   
Image:          nginx:1.12.1-alpine

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl describe po ds-two-kpsfx | <span class="nb">grep</span> <span class="s2">"Image:"</span>
Image:          nginx:1.12.1-alpine

<span class="c"># rollout 된 상태 확인</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl rollout status ds ds-two 
daemon <span class="nb">set</span> <span class="s2">"ds-two"</span> successfully rolled out

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl rollout <span class="nb">history </span>ds ds-two
daemonset.extensions/ds-two 
REVISION  CHANGE-CAUSE
1         &lt;none&gt;
2         &lt;none&gt;

ps0107@k8smaster1:~<span class="nv">$ </span>kubectl rollout <span class="nb">history </span>ds ds-two <span class="nt">--revision</span><span class="o">=</span>2
daemonset.extensions/ds-two with revision <span class="c">#2</span>
Pod Template:
  Labels:system<span class="o">=</span>ReplicaOne
  Containers:
   nginx:
    Image:nginx:1.12.1-alpine
    Port:80/TCP
    Host Port:0/TCP
    Environment:&lt;none&gt;
    Mounts:&lt;none&gt;
  Volumes:&lt;none&gt;

<span class="c"># 테스트한 객체 삭제</span>
ps0107@k8smaster1:~<span class="nv">$ </span>kubectl delete ds ds-two 
daemonset.extensions <span class="s2">"ds-two"</span> deleted
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/kubernetes/'>Kubernetes</a>, <a href='/categories/kubernetes-administration-course/'>Kubernetes Administration Course</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/kubernetes/" class="post-tag no-text-decoration" >kubernetes</a> <a href="/tags/cka/" class="post-tag no-text-decoration" >cka</a> <a href="/tags/lfs458/" class="post-tag no-text-decoration" >LFS458</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=[kubernetes-실습] Managing State with Deployments - ps's Blog&url=https://ps2046.github.io/posts/10.Managing_State_with_Deployments/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=[kubernetes-실습] Managing State with Deployments - ps's Blog&u=https://ps2046.github.io/posts/10.Managing_State_with_Deployments/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=[kubernetes-실습] Managing State with Deployments - ps's Blog&url=https://ps2046.github.io/posts/10.Managing_State_with_Deployments/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/blog-comments-utterances/">[blog] github blog comments (utterances)</a><li><a href="/posts/17.kubernetes_Scheduling_2/">[kubernetes-실습] Scheduling - Taint를 이용한 pod 배포 관리</a><li><a href="/posts/18.kubernetes_logging_trubleshooting_1/">[kubernetes-실습] 로깅과 트러블슈팅 : 로그위치와 로그 출력 보기</a><li><a href="/posts/19.kubernetes_logging_trubleshooting_2/">[kubernetes-실습] 로깅과 트러블슈팅 : Metrics와 DashBoard</a><li><a href="/posts/20.kubernetes_crd/">[kubernetes-실습] CRD (Custom Resource Definition)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cka/">cka</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/lfs458/">LFS458</a> <a class="post-tag" href="/tags/bash/">bash</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/comments/">comments</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/monitoring/">monitoring</a> <a class="post-tag" href="/tags/system/">system</a> <a class="post-tag" href="/tags/utterances/">utterances</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/17.kubernetes_Scheduling_2/"><div class="card-body"> <span class="timeago small" >Jan 26<i class="unloaded">2021-01-26T08:30:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[kubernetes-실습] Scheduling - Taint를 이용한 pod 배포 관리</h3><div class="text-muted small"><p> Using Taints to Control Pod Deployment taints를 사용하여 어느곳에 pod가 배치되거나 실행을 허용하도록 관리할수 있다. 노드 그룹에 pod들을 할당하여 추가할때 노드 사용을 제한하거나 pod들을 완전히 대피시킬수 있다. 참고 마스터노드가 처음에 NoSchedule taint로 설정되어 있었던것을 기억할 것이다...</p></div></div></a></div><div class="card"> <a href="/posts/18.kubernetes_logging_trubleshooting_1/"><div class="card-body"> <span class="timeago small" >Jan 26<i class="unloaded">2021-01-26T09:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[kubernetes-실습] 로깅과 트러블슈팅 : 로그위치와 로그 출력 보기</h3><div class="text-muted small"><p> 로그 파일들의 위치 알아보기 다양한 로그 파일과 명령 출력 이외에도 journalctl을 사용하여 노드 관점에서 로그를 볼 수 있다. 우리는 로그 파일의 공통적인 위치를 보고, 컨테이너 로그를 보는 명령을 볼 것이다. 다른 컨테이너의 로그를 pod에 적재하는데 전용으로 사용되는 sidecar container의 사용과 같은 다른 로깅 ...</p></div></div></a></div><div class="card"> <a href="/posts/19.kubernetes_logging_trubleshooting_2/"><div class="card-body"> <span class="timeago small" >Jan 26<i class="unloaded">2021-01-26T10:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>[kubernetes-실습] 로깅과 트러블슈팅 : Metrics와 DashBoard</h3><div class="text-muted small"><p> Metrics 설정 heapster가 deprecation 되면서 Metrics Server 와 통합되어 개발되고 배포되어지고 있다. 그리고 CNCF의 프로젝트중 프로메테우스도 잘 사용되어지고 있다. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 3...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/09.kubernetes_API/" class="btn btn-outline-primary" prompt="Older"><p>[kubernetes-실습] API 객체</p></a> <a href="/posts/11.kubernetes_Service_Resource/" class="btn btn-outline-primary" prompt="Newer"><p>[kubernetes-실습] Service Resource</p></a></div><script src="https://utteranc.es/client.js" repo="ps2046/ps2046-github-io-comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async> </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://ps2046.github.io">ps.jang</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/cka/">cka</a> <a class="post-tag" href="/tags/kubernetes/">kubernetes</a> <a class="post-tag" href="/tags/lfs458/">LFS458</a> <a class="post-tag" href="/tags/bash/">bash</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/comments/">comments</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/monitoring/">monitoring</a> <a class="post-tag" href="/tags/system/">system</a> <a class="post-tag" href="/tags/utterances/">utterances</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://ps2046.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-158837927-2"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-158837927-2'); }); </script>
